(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[486],{10746:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){let a=n.default,s={loading:e=>{let{error:t,isLoading:a,pastDelay:l}=e;return null}};e instanceof Promise?s.loader=()=>e:"function"==typeof e?s.loader=e:"object"==typeof e&&(s=l({},s,e)),s=l({},s,t);let r=s.loader,i=()=>r().then(o);if(s.loadableGenerated&&delete(s=l({},s,s.loadableGenerated,{loader:i})).loadableGenerated,"boolean"==typeof s.ssr){if(!s.ssr)return delete s.ssr,d(i,s);delete s.ssr}return a(s)},t.noSSR=d;var l=a(22770).Z,s=a(95489).Z,r=(0,a(56593).Z)(a(82684)),n=s(a(36445)),i=s(a(70147));function o(e){return{default:e.default||e}}function d(e,t){delete t.webpack,delete t.modules;let a=r.lazy(e),l=t.loading,s=r.default.createElement(l,{error:null,isLoading:!0,pastDelay:!1,timedOut:!1});return e=>r.default.createElement(r.Suspense,{fallback:s},r.default.createElement(i.default,null,r.default.createElement(a,Object.assign({},e))))}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},96945:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LoadableContext=void 0;var l=(0,a(95489).Z)(a(82684));let s=l.default.createContext(null);t.LoadableContext=s},36445:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var l=a(22770).Z,s=(0,a(95489).Z)(a(82684)),r=a(96945);let n=[],i=[],o=!1;function d(e){let t=e(),a={loading:!0,loaded:null,error:null};return a.promise=t.then(e=>(a.loading=!1,a.loaded=e,e)).catch(e=>{throw a.loading=!1,a.error=e,e}),a}class c{promise(){return this._res.promise}retry(){this._clearTimeouts(),this._res=this._loadFn(this._opts.loader),this._state={pastDelay:!1,timedOut:!1};let{_res:e,_opts:t}=this;e.loading&&("number"==typeof t.delay&&(0===t.delay?this._state.pastDelay=!0:this._delay=setTimeout(()=>{this._update({pastDelay:!0})},t.delay)),"number"==typeof t.timeout&&(this._timeout=setTimeout(()=>{this._update({timedOut:!0})},t.timeout))),this._res.promise.then(()=>{this._update({}),this._clearTimeouts()}).catch(e=>{this._update({}),this._clearTimeouts()}),this._update({})}_update(e){this._state=l({},this._state,{error:this._res.error,loaded:this._res.loaded,loading:this._res.loading},e),this._callbacks.forEach(e=>e())}_clearTimeouts(){clearTimeout(this._delay),clearTimeout(this._timeout)}getCurrentValue(){return this._state}subscribe(e){return this._callbacks.add(e),()=>{this._callbacks.delete(e)}}constructor(e,t){this._loadFn=e,this._opts=t,this._callbacks=new Set,this._delay=null,this._timeout=null,this.retry()}}function u(e){return function(e,t){let a=Object.assign({loader:null,loading:null,delay:200,timeout:null,webpack:null,modules:null},t);a.lazy=s.default.lazy(a.loader);let l=null;function n(){if(!l){let t=new c(e,a);l={getCurrentValue:t.getCurrentValue.bind(t),subscribe:t.subscribe.bind(t),retry:t.retry.bind(t),promise:t.promise.bind(t)}}return l.promise()}if(!o){let d=a.webpack?a.webpack():a.modules;d&&i.push(e=>{for(let t of d)if(-1!==e.indexOf(t))return n()})}function u(e){!function(){n();let e=s.default.useContext(r.LoadableContext);e&&Array.isArray(a.modules)&&a.modules.forEach(t=>{e(t)})}();let t=s.default.createElement(a.loading,{isLoading:!0,pastDelay:!0,error:null});return s.default.createElement(s.default.Suspense,{fallback:t},s.default.createElement(a.lazy,e))}return u.preload=()=>n(),u.displayName="LoadableComponent",u}(d,e)}function m(e,t){let a=[];for(;e.length;){let l=e.pop();a.push(l(t))}return Promise.all(a).then(()=>{if(e.length)return m(e,t)})}u.preloadAll=()=>new Promise((e,t)=>{m(n).then(e,t)}),u.preloadReady=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return new Promise(t=>{let a=()=>(o=!0,t());m(i,e).then(a,a)})},window.__NEXT_PRELOADREADY=u.preloadReady,t.default=u},51774:function(e,t,a){a(10746)},12267:function(e,t,a){"use strict";a.d(t,{o8:function(){return j}});var l=a(87778),s=a(83418),r=a(82684),n=a(34071),i=a(82431),o=a(47139);let d=r.forwardRef(function({title:e,titleId:t,...a},l){return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:l,"aria-labelledby":t},a),e?r.createElement("title",{id:t},e):null,r.createElement("path",{fillRule:"evenodd",d:"M17 4.25A2.25 2.25 0 0 0 14.75 2h-5.5A2.25 2.25 0 0 0 7 4.25v2a.75.75 0 0 0 1.5 0v-2a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v11.5a.75.75 0 0 1-.75.75h-5.5a.75.75 0 0 1-.75-.75v-2a.75.75 0 0 0-1.5 0v2A2.25 2.25 0 0 0 9.25 18h5.5A2.25 2.25 0 0 0 17 15.75V4.25Z",clipRule:"evenodd"}),r.createElement("path",{fillRule:"evenodd",d:"M1 10a.75.75 0 0 1 .75-.75h9.546l-1.048-.943a.75.75 0 1 1 1.004-1.114l2.5 2.25a.75.75 0 0 1 0 1.114l-2.5 2.25a.75.75 0 1 1-1.004-1.114l1.048-.943H1.75A.75.75 0 0 1 1 10Z",clipRule:"evenodd"}))}),c=r.forwardRef(function({title:e,titleId:t,...a},l){return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:l,"aria-labelledby":t},a),e?r.createElement("title",{id:t},e):null,r.createElement("path",{d:"m13.28 7.78 3.22-3.22v2.69a.75.75 0 0 0 1.5 0v-4.5a.75.75 0 0 0-.75-.75h-4.5a.75.75 0 0 0 0 1.5h2.69l-3.22 3.22a.75.75 0 0 0 1.06 1.06ZM2 17.25v-4.5a.75.75 0 0 1 1.5 0v2.69l3.22-3.22a.75.75 0 0 1 1.06 1.06L4.56 16.5h2.69a.75.75 0 0 1 0 1.5h-4.5a.747.747 0 0 1-.75-.75ZM12.22 13.28l3.22 3.22h-2.69a.75.75 0 0 0 0 1.5h4.5a.747.747 0 0 0 .75-.75v-4.5a.75.75 0 0 0-1.5 0v2.69l-3.22-3.22a.75.75 0 1 0-1.06 1.06ZM3.5 4.56l3.22 3.22a.75.75 0 0 0 1.06-1.06L4.56 3.5h2.69a.75.75 0 0 0 0-1.5h-4.5a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 1.5 0V4.56Z"}))});function u({setActiveAnalysisId:e,setActiveRootAnalysisId:t,setAddToDashboardSelection:a=(...e)=>{},analysis:n=null,isActive:i=!1,extraClasses:o="",isDummy:d=!1,onClick:c=()=>{}}){let u=(0,r.useContext)(l.A);return s.j.jsxs("div",{className:(0,s.t)("flex flex-row items-center py-1 px-2 mb-2 hover:cursor-pointer hover:bg-gray-200 history-item",i?"font-bold bg-gray-200 ":"",d?"dummy-analysis":n.analysisId,o),onClick:()=>{t(null==n?void 0:n.rootAnalysisId),e(null==n?void 0:n.analysisId),c()},children:[s.j.jsx("div",{className:"grow",children:d?"New analysis":(0,s.s)(null==n?void 0:n.user_question)}),!d&&u.val.allowDashboardAdd&&s.j.jsx("div",{className:"rounded-sm hover:bg-blue-500 p-1 flex justify-center group ",onClick:()=>{e(null==n?void 0:n.analysisId),a(n)},children:s.j.jsx(l.F,{className:"h-4 w-4 text-gray-400 group-hover:text-white"})})]})}let m=({analyses:e,activeAnalysisId:t})=>{let[a,l]=(0,r.useState)([]),n=(0,r.useRef)(null);return(0,r.useEffect)(()=>{if(!n.current)return;if(!t){a.length>0&&l([]);return}let s=n.current.closest(".history-list");if(!s)return;s.querySelectorAll(".linked-active").forEach(e=>{e.classList.remove("linked-active")}),s.querySelectorAll(".current-active").forEach(e=>{e.classList.remove("current-active")});let r=s.querySelector(`.${t}`);r&&r.classList.add("current-active");let i=e[t],o=[],d=[];for(;o.length<20&&!i.isRoot;){let c=e[i.directParentId];o.push(c);let u=s.getBoundingClientRect(),m=s.querySelector(`.${i.analysisId}`),h=s.querySelector(`.${c.analysisId}`),f=m.getBoundingClientRect(),y=h.getBoundingClientRect(),g={x:f.left-u.left-8,y:f.top-u.top+f.height/2},p={x:y.left-u.left-8,y:y.top-u.top+y.height/2},b=p.y-g.y,x=p.x-(g.x-10),v=`M ${g.x} ${g.y} l -10 0 l 0 ${b} l ${x} 0`;d.push(v),i=c}o.forEach(e=>{let t=s.querySelector(`.${e.analysisId}`);t&&t.classList.add("linked-active")}),l(d)},[e,t]),s.j.jsx("div",{className:"absolute l-0 t-0 pointer-events-none overflow-visible",ref:n,children:s.j.jsx("svg",{width:"100%",height:"100%",className:"overflow-visible",children:a.map((e,t)=>s.j.jsx("path",{d:e,className:"fill-transparent stroke-blue-300 text-blue-500",strokeWidth:"1"},t))})})};function h({analysisTreeManager:e,keyName:t,isTemp:a=!1,forceSqlOnly:o=!1,metadata:h=null,predefinedQuestions:f=[],autoScroll:y=!0,sideBarClasses:g="",searchBarClasses:p="",searchBarDraggable:b=!0,defaultSidebarOpen:x=!1,showToggle:v=!0}){var j;let w=(0,r.useContext)(s.M),A=(0,s.u)(),N=(0,r.useRef)({}),[C,_]=(0,r.useState)(!1),[k,E]=(0,r.useState)(o),S=(0,r.useRef)(null),I=(0,r.useRef)(null),[T,M]=(0,r.useState)(!1),[O,F]=(0,r.useState)([]),{dashboards:D}=(0,r.useContext)(l.A).val,[R,q]=(0,r.useState)(x),P=(0,n.u)(),z=(0,r.useSyncExternalStore)(e.subscribeToDataChanges,e.getTree),L=(0,r.useSyncExternalStore)(e.subscribeToDataChanges,e.getAll),B=(0,r.useSyncExternalStore)(e.subscribeToActiveAnalysisIdChanges,e.getActiveAnalysisId),U=(0,r.useSyncExternalStore)(e.subscribeToActiveAnalysisIdChanges,e.getActiveRootAnalysisId);(0,r.useEffect)(()=>{_(!1),F([]),M(!1),N.current={}},[e]);let V=(0,r.useCallback)(async function(l,s=null,r=!1,n=null){try{if(!e)throw Error("Analysis tree manager not found");_(!0);let{newId:i,newAnalysis:d}=await e.submit({question:l,rootAnalysisId:s,keyName:t,isRoot:r,directParentId:n,sqlOnly:o||k,isTemp:a});s||e.setActiveRootAnalysisId(d.analysisId),e.setActiveAnalysisId(d.analysisId),e.setActiveRootAnalysisId(d.rootAnalysisId),I.current.value=""}catch(c){w.error("Failed to create analysis"),console.log(c.stack)}finally{_(!1)}},[e,o,k,a,t,h]);function $(e){var t,a;null!=(a=null==(t=N.current)?void 0:t[e])&&a.ctr&&N.current[e].ctr.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}return(0,r.useEffect)(()=>{if(b)return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)};function e(){S.current&&(S.current.style.left="0",S.current.style.right="0",S.current.style.bottom=window.innerWidth>1600?"30%":"20px")}},[b]),window.ref=I,s.j.jsxs(l.E,{children:[s.j.jsxs("div",{className:"relative h-full",children:[B&&U&&s.j.jsx("div",{className:"lg:hidden absolute bottom-0 left-0 w-full h-[10%] pointer-events-none bg-gradient-to-b from-transparent to-gray-300 z-10"}),s.j.jsxs("div",{className:"analysis-tree-viewer max-w-full h-full flex flex-row bg-white text-gray-600 w-full",children:[s.j.jsx("div",{className:"absolute h-full left-0 top-0 z-[20] lg:sticky lg:h-full",children:s.j.jsx(i.S,{location:"left",open:R,onChange:e=>{q(e)},title:s.j.jsx("span",{className:"font-bold",children:"History"}),rootClassNames:(0,s.t)("transition-all z-20 h-[calc(100%-1rem)] rounded-md rounded-l-none lg:rounded-none lg:rounded-tr-md lg:rounded-br-md bg-gray-100 border-r sticky top-0 lg:relative",g),iconClassNames:`${R?"":"text-white bg-secondary-highlight-2"}`,openClassNames:"border-gray-300 shadow-md",closedClassNames:"border-transparent bg-transparent shadow-none",contentClassNames:"w-72 px-2 pt-5 pb-14 rounded-tl-lg relative sm:block pl-4 min-h-96 h-full overflow-y-auto",children:s.j.jsxs("div",{className:"flex flex-col text-sm relative history-list",children:[s.j.jsx(m,{analyses:L,activeAnalysisId:null!=L&&L[B]?B:null}),Object.keys(z).map((t,a)=>{var l;let r=z[t].root,i=(null==(l=null==z?void 0:z[t])?void 0:l.analysisList)||[];return s.j.jsx("div",{className:"",children:i.map((t,a)=>s.j.jsx(u,{analysis:t,isActive:B===t.analysisId,setActiveRootAnalysisId:e.setActiveRootAnalysisId,setActiveAnalysisId:e.setActiveAnalysisId,setAddToDashboardSelection:M,onClick:()=>{y&&$(t.analysisId),P[0]<n.b.lg&&q(!1)},extraClasses:t.isRoot?"":"ml-2 border-l-2"},t.analysisId))},r.analysisId)}),U?s.j.jsxs("div",{className:"w-full mt-5 sticky bottom-5",children:[s.j.jsxs("div",{"data-enabled":!C,className:(0,s.t)("flex items-center cursor-pointer z-20 relative","data-[enabled=true]:bg-blue-200 data-[enabled=true]:hover:bg-blue-500 data-[enabled=true]:hover:text-white p-2 data-[enabled=true]:text-blue-400 data-[enabled=true]:shadow-custom ","data-[enabled=false]:bg-gray-100 data-[enabled=false]:hover:bg-gray-100 data-[enabled=false]:hover:text-gray-400 data-[enabled=false]:text-gray-400 data-[enabled=false]:cursor-not-allowed"),onClick:()=>{C||(e.setActiveRootAnalysisId(null),e.setActiveAnalysisId(null),P[0]<n.b.lg&&q(!1))},children:["New ",s.j.jsx(l.F,{className:"ml-2 w-4 h-4 inline"})]}),s.j.jsx("div",{className:"absolute w-full h-10 bg-gray-100 z-0"})]}):s.j.jsx(u,{isDummy:!0,setActiveRootAnalysisId:e.setActiveRootAnalysisId,setActiveAnalysisId:e.setActiveAnalysisId,isActive:!U})]})})}),s.j.jsx("div",{className:(0,s.t)("absolute left-0 top-0 h-full w-full overlay lg:hidden bg-gray-800 z-[11] transition-all",R?"opacity-50 block":"opacity-0 pointer-events-none"),onClick:()=>{q(!1)}}),s.j.jsxs("div",{className:"grid grid-cols-1 pt-10 sm:pt-0 auto-cols-max lg:grid-cols-1 grow rounded-tr-lg p-2 lg:p-4 relative min-w-0 h-full overflow-scroll",children:[U&&(null==(j=null==z?void 0:z[U])?void 0:j.analysisList)&&z[U].analysisList.map(t=>s.j.jsx(l.a,{metadata:h,rootClassNames:"w-full mb-4 [&_.analysis-content]:min-h-96 shadow-md analysis-"+t.analysisId,analysisId:t.analysisId,createAnalysisRequestBody:t.createAnalysisRequestBody,initiateAutoSubmit:!0,hasExternalSearchBar:!0,setGlobalLoading:_,sqlOnly:t.sqlOnly,isTemp:t.isTemp,keyName:t.keyName,onManagerCreated:(a,l,s)=>{N.current[l]={ctr:s,analysisManager:a,id:l},y&&$(l),e.updateAnalysis({analysisId:t.analysisId,isRoot:t.isRoot,updateObj:{analysisManager:a}})},onManagerDestroyed:(a,l)=>{e.removeAnalysis({analysisId:t.analysisId,isRoot:t.isRoot,rootAnalysisId:t.rootAnalysisId}),e.setActiveAnalysisId(null),U===l&&e.setActiveRootAnalysisId(null),_(!1)},initialConfig:{analysisManager:t.analysisManager||null}},t.analysisId)),!B&&s.j.jsx("div",{className:" grow flex flex-col place-content-center m-auto max-w-full relative z-[1]",children:s.j.jsxs("div",{className:"text-gray-400 text-center rounded-md",children:[s.j.jsx("p",{className:"cursor-default block text-sm mb-4 font-bold",children:"Quickstart"}),s.j.jsx("ul",{className:"text-gray-500 font-light",children:f.map((e,t)=>s.j.jsx("li",{className:"",children:s.j.jsx("button",{className:(0,s.t)("cursor-pointer text-sm p-2 m-1 border border-gray-200 rounded-md shadow-sm",C?"bg-gray-100 text-gray-300 cursor-not-allowed":"hover:bg-gray-50 hover:border"),onClick:t=>{C||V((0,s.s)(e),U,!U,B)},children:(0,s.s)(e)})},t))})]})}),s.j.jsxs("div",{className:(0,s.t)("w-full lg:w-8/12 m-auto fixed z-20 bg-white rounded-lg shadow-custom border border-gray-400 hover:border-blue-500 focus:border-blue-500 flex flex-row",p),style:{left:"0",right:"0",bottom:b?window.innerWidth>1600?"30%":"20px":null},ref:S,children:[b&&s.j.jsx("div",{className:"cursor-move min-h-full w-3 flex items-center ml-1 group",draggable:b,onDragStart:e=>{b&&e.dataTransfer.setDragImage(A,0,0)},onDrag:e=>{if(!b||!e.clientX||!e.clientY||!S.current)return;let t=window.innerHeight-e.clientY-S.current.clientHeight,a=e.clientX,l=window.innerHeight-20-S.current.clientHeight;t<20?S.current.style.bottom="20px":t>l?S.current.style.bottom=l+"px":S.current.style.bottom=t+"px";let s=window.innerWidth-S.current.clientWidth-20;S.current.style.right="auto",a<20?S.current.style.left="20px":a>s?S.current.style.left=s+"px":S.current.style.left=a+"px"},children:s.j.jsx(c,{className:"h-3 w-3 text-gray-400 group-hover:text-primary-text"})}),s.j.jsx("div",{className:"grow rounded-md lg:items-center flex flex-col-reverse lg:flex-row",children:s.j.jsxs("div",{className:"flex flex-row grow",children:[s.j.jsxs("div",{className:"flex lg:flex-row-reverse lg:items-center flex-col grow",children:[s.j.jsx(s.T,{rootClassNames:"grow border-none bg-transparent py-1.5 text-gray-900 px-2 placeholder:text-gray-400 sm:leading-6 text-sm break-all focus:ring-0 focus:outline-none",textAreaClassNames:"resize-none",ref:I,disabled:C,defaultRows:1,onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),e.stopPropagation(),V(I.current.value,U,!U,B))},placeholder:U?"Type your next question here":"Type your question here"}),v&&s.j.jsx(i.T,{disabled:o||C,titleClassNames:"font-bold text-gray-400",onToggle:e=>{o||E(!e)},defaultOn:!k,offLabel:"Advanced",onLabel:"Advanced",rootClassNames:"items-start lg:border-r py-2 lg:py-0 px-2 w-32"})]}),s.j.jsxs("button",{type:"button",className:"relative -ml-px inline-flex items-center gap-x-1.5 rounded-r-md px-3 p-0 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-blue-500 hover:bg-blue-500 hover:text-white",onClick:()=>{V(I.current.value,U,!U,B)},children:[s.j.jsx(d,{className:"-ml-0.5 h-5 w-5 text-gray-400","aria-hidden":"true"}),"Ask"]})]})})]})]})]})]}),s.j.jsx(l.M,{title:"Select the dashboards to add this analysis to",open:T,onOk:()=>{},onCancel:()=>{M(!1)},children:s.j.jsx("div",{className:"dashboard-selection mt-8 flex flex-col max-h-80 overflow-scroll bg-gray-100 rounded-md",children:D.map(e=>s.j.jsxs("div",{className:"flex flex-row p-2 hover:bg-gray-200 cursor-pointer text-gray-400 items-start "+(O.includes(e.doc_id)&&"text-gray-600 font-bold"),onClick:()=>{O.includes(e.doc_id)?F(O.filter(t=>t!==e.doc_id)):F([...O,e.doc_id])},children:[s.j.jsx("div",{className:"checkbox mr-3",children:s.j.jsx("input",{className:"appearance-none w-3 h-3 border border-gray-300 rounded-md checked:bg-blue-600 checked:border-transparent",type:"checkbox",checked:O.includes(e.doc_id),readOnly:!0})}),s.j.jsx("div",{className:"grow",children:e.doc_title})]},e.doc_id))})})]})}function f({rootClassNames:e=e=>"",availableDbs:t=[],defaultSelectedDb:a=null,allowUploadFile:l=!0,onDbChange:i=(...e)=>{},children:d=null,fileUploading:c=!1,onParseCsv:u=(...e)=>{}}){let[m,h]=(0,r.useState)(a),[f,y]=(0,r.useState)(!1),g=(0,r.useContext)(s.M);return(0,r.useEffect)(()=>{h(a)},[a]),s.j.jsxs("div",{className:(0,s.t)("w-full h-full p-2","function"==typeof e?e(m):""),children:[s.j.jsxs("div",{className:"w-full relative mb-4 text-gray-500 text-xs flex flex-row",children:[s.j.jsx("div",{className:"h-full mr-2 font-bold z-10 whitespace-nowrap py-2",children:"Dataset:"}),s.j.jsx("div",{className:"overflow-scroll flex flex-row gap-2 px-2 items-center rounded-md",children:t.map((e,t)=>s.j.jsx("span",{onClick:()=>{c||(h(e),i(e))},className:(0,s.t)("p-2 bg-gray-200 border border-gray-300 rounded-full cursor-pointer whitespace-nowrap",m===e?"bg-gray-600 border-transparent text-white":"hover:bg-gray-300",c?"cursor-not-allowed bg-gray-200 text-gray-400 hover:bg-gray-200":""),children:e},e+"-"+t))}),s.j.jsx("div",{className:"self-end ml-auto pl-3",children:l&&s.j.jsx(o.D,{rootClassNames:"flex items-center cursor-pointer group ml-auto self-end",disabled:c,onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),y(!0),console.log(e.target)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),y(!1)},onFileSelect:e=>{try{let t=e.target.files[0];if(!t)return;if("text/csv"!==t.type)throw Error("Only CSV files are accepted");(0,s.p)(t,u)}catch(a){g.error(a.message||"Only CSV files are accepted."),y(!1)}},onDrop:e=>{var t,a;console.log("here"),e.preventDefault();try{let l=null==(a=null==(t=null==e?void 0:e.dataTransfer)?void 0:t.items)?void 0:a[0];if(console.log(l),!l)return;if(!l.kind||"file"!==l.kind||"text/csv"!==l.type)throw Error("Only CSV files are accepted");l=l.getAsFile(),(0,s.p)(l,u)}catch(r){g.error(r.message||"Failed to parse the file"),console.log(r.stack),y(!1)}},children:s.j.jsx("span",{className:(0,s.t)("rounded-full cursor-pointe p-2 flex items-center whitespace-nowrap",c?"bg-gray-200 text-gray-400":"bg-secondary-highlight-1/40 text-white group-hover:bg-secondary-highlight-1 group-hover:text-white"),children:c?s.j.jsxs(s.j.Fragment,{children:["Uploading",s.j.jsx(s.S,{classNames:"h-4 w-4 inline m-0 ml-2 text-gray-500"})]}):s.j.jsxs(s.j.Fragment,{children:[s.j.jsx("span",{className:"hidden sm:inline",children:f?"Drop here!":"Upload / Drop a CSV"}),s.j.jsx("span",{className:"inline sm:hidden",children:"Upload a CSV"}),s.j.jsx(n.F,{className:"h-4 w-4 inline ml-1"})]})})})})]}),d]})}function y(e={},t=(0,s.v)()){let a=e,l=Object.values(a).reduce((e,t)=>({...e,[t.root.analysisId]:t.root,...t.analysisList.reduce((e,t)=>({...e,[t.analysisId]:t}),{})}),{}),r=[],n=[],i=null,o=null;function d(e,t){a=e,l=t,r.forEach(e=>e())}function c(){n.forEach(e=>e())}return{subscribeToDataChanges:function(e){return r=[...r,e],function(){r=r.filter(t=>t!==e)}},getTree:function(){return a},getAll:function(){return l},subscribeToActiveAnalysisIdChanges:function(e){return n.push(e),function(){n=n.filter(t=>t!==e)}},setActiveAnalysisId:function(e){i=e,c()},setActiveRootAnalysisId:function(e){o=e,c()},getActiveAnalysisId:function(){return i},getActiveRootAnalysisId:function(){return o},submit:async function({question:e,keyName:t,rootAnalysisId:r=null,isRoot:n=!1,directParentId:i=null,sqlOnly:o=!1,isTemp:c=!1}){let u="analysis-"+(0,s.v)(),m={analysisId:u,isRoot:n,rootAnalysisId:n?u:r,user_question:e,existingAnalysisData:null,isTemp:c,keyName:t,sqlOnly:o};m.directParentId=i,m.createAnalysisRequestBody={other_data:{user_question:e,is_root_analysis:n,root_analysis_id:r,direct_parent_id:i},sql_only:o};let h={...a};if(r){let f=a[r].root;h[f.analysisId].analysisList.push(m)}else h[m.analysisId]={root:m,analysisList:[m]};let y={...l,[m.analysisId]:m};return d(h,y),{newId:u,newAnalysis:m}},removeAnalysis:function({analysisId:e,isRoot:t,rootAnalysisId:s}){let r={...a};if(t)delete r[e];else if(s){let n=r[s];n&&(n.analysisList=n.analysisList.filter(t=>t.analysisId!==e))}let i={...l};delete i[e],d(r,i)},updateAnalysis:function({analysisId:e,isRoot:t,updateObj:s,emit:r=!0}){let n={...a};if(!l[e]){console.warn("Analysis not found",e);return}t&&(n[e].root={...n[e].root,...s});let i=l[e].rootAnalysisId;n[i].analysisList=n[i].analysisList.map(t=>t.analysisId===e?{...t,...s}:t);let o={...l};o[e]={...o[e],...s},d(n,o)},getMgrId:()=>t,reset:function(){d({},{})}}}function g({apiEndpoint:e=null,db:t=null,token:a=null,onGetMetadata:n=(...e)=>{}}){let i=(0,r.useContext)(s.M),{keyName:d,metadata:c,isTemp:u}=t||{};(0,r.useEffect)(()=>{if(!t)return;let l=!!t.metadata;async function s(){let t;if(!e||!d||!a){i.error("Failed to get metadata");return}try{if((t=await (await fetch(`${e}/integration/get_metadata`,{signal:AbortSignal.timeout(1e4),method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({token:a,key_name:d,temp:u})})).json()).error)throw Error(t.error)}catch(l){console.log(l),i.error("Error getting metadata: "+t.error),t={error:t.error||"Error fetching metadata."}}finally{n(t)}}l||t.metadataFetchingError||s()},[t]);let m=(0,r.useMemo)(()=>Array.isArray(c)&&!t.metadataFetchingError?Array.from(new Set(c.map(e=>e.table_name))):[],[c,t]),h=Array.isArray(c)&&!t.metadataFetchingError?[{dataIndex:"table_name",title:"table_name",key:"table_name"},{dataIndex:"column_name",title:"column_name",key:"column_name"},{dataIndex:"column_description",title:"column_description",key:"column_description"},{dataIndex:"data_type",title:"data_type",key:"data_type"}]:[],[f,y]=(0,r.useState)(m);(0,r.useEffect)(()=>{y(m)},[d+m.join(",")]);let g=Array.isArray(c)&&!t.metadataFetchingError?c.filter(e=>0===f.length||f.includes(e.table_name)):[];return s.j.jsx(l.E,{children:s.j.jsx("div",{className:(0,s.t)("p-2 w-full h-full flex ",Array.isArray(c)&&!t.metadataFetchingError?"flex-col items-start justify-start":"items-center justify-center"),children:Array.isArray(c)&&!t.metadataFetchingError?s.j.jsx(s.j.Fragment,{children:s.j.jsxs("div",{className:"flex flex-col justify-center w-full",children:[s.j.jsx("div",{className:"py-2 border-b bg-white sticky top-2 mb-3 z-[20]",children:s.j.jsx(o.M,{rootClassNames:"max-w-full",placeholder:"Filter tables",value:[],options:m.map(e=>({label:e,value:e})),onChange:e=>{y(e)},allowCreateNewOption:!1})}),s.j.jsx(s.a,{pagination:{defaultPageSize:5},paginationPosition:"top",rootClassNames:"rounded-md max-w-full",columns:h,rows:g,columnHeaderClassNames:"py-2"})]})}):s.j.jsx("div",{className:"text-center",children:t.metadataFetchingError?t.metadataFetchingError:s.j.jsxs(s.j.Fragment,{children:[s.j.jsx("div",{children:"Fetching"})," ",s.j.jsx(s.S,{classNames:"w-4 h-4 text-gray-500"})]})})})})}function p({keyName:e,treeManager:t,predefinedQuestions:a,searchBarDraggable:r=!0,isTemp:n=!1,forceSqlOnly:i=!1,metadata:o=null,sideBarClasses:d="h-full",searchBarClasses:c="",defaultSidebarOpen:u=null}){return s.j.jsx(l.E,{children:s.j.jsx(h,{keyName:e,metadata:o,isTemp:n,forceSqlOnly:i,analysisTreeManager:t,autoScroll:!0,sideBarClasses:d,searchBarClasses:(0,s.t)(r?"":"sticky bottom-1","[&_textarea]:pl-2",c),searchBarDraggable:r,showToggle:!i,defaultSidebarOpen:u||!(window.innerWidth<768),predefinedQuestions:a})})}function b({apiEndpoint:e=null,db:t=null,token:a=null,onGetData:n=(...e)=>{}}){var i,o,d,c;console.log(t);let u=(0,r.useContext)(s.M),{keyName:m,isTemp:h}=t||{};(0,r.useEffect)(()=>{t&&t.metadata&&!t.metadataFetchingError&&(!t.dataFetchingError&&!t.metadataFetchingError&&t.metadata&&t.data&&Object.keys(t.data).length>0||l());async function l(){let l;let s=Array.isArray(t.metadata)&&!t.metadataFetchingError?Array.from(new Set(t.metadata.map(e=>e.table_name))):[],r={};s.forEach(async(t,i)=>{let o;r[t]={data:[],columns:[],error:!1};try{if(!e||!m||!a)throw Error("Failed to get data");if((o=await (await fetch(`${e}/integration/preview_table`,{signal:AbortSignal.timeout(1e4),method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({token:a,key_name:m,temp:h,table_name:t})})).json()).error)throw Error(o.error);o.tableName=t}catch(d){console.log(d),l=d,u.error("Error getting data: "+o.error),o={error:o.error||"Failed to fetch data.",data:[],columns:[]}}finally{r[t]={...r[t],data:o.data.slice(),columns:o.columns.slice()},i===s.length-1&&n({data:r,error:l})}})}},[t]);let f=!t.dataFetchingError&&!t.metadataFetchingError&&t.metadata&&t.data&&Object.keys(t.data).length>0,y=t.dataFetchingError||t.metadataFetchingError,g=Array.isArray(t.metadata)&&!t.metadataFetchingError?Array.from(new Set(t.metadata.map(e=>e.table_name))):[],[p,b]=(0,r.useState)(0),x=((null==(o=null==(i=null==t?void 0:t.data)?void 0:i[null==g?void 0:g[p]])?void 0:o.columns)||[]).map(e=>({dataIndex:e,key:e,title:e})),v=((null==(c=null==(d=null==t?void 0:t.data)?void 0:d[null==g?void 0:g[p]])?void 0:c.data)||[]).map(e=>{let t={};return x.forEach((a,l)=>{t[a.dataIndex]=e[l]}),t});return s.j.jsx(l.E,{children:s.j.jsx("div",{className:(0,s.t)("p-2 w-full h-full flex ",f?"":"items-center justify-center"),children:f?s.j.jsx(s.j.Fragment,{children:s.j.jsxs("div",{className:"flex flex-col py-2 relative w-full",children:[s.j.jsx("div",{className:"flex flex-row items-center mb-4 sticky top-4 z-[20] bg-white p-2 border-b",children:s.j.jsx(s.b,{value:p,onChange:e=>b(e),options:g.map((e,t)=>({value:t,label:e})),allowClear:!1,label:"Select table",allowCreateNewOption:!1})}),s.j.jsx("div",{className:"max-w-full overflow-scroll",children:s.j.jsx(s.a,{pagination:{defaultPageSize:5},paginationPosition:"top",rootClassNames:"rounded-md max-w-full",columns:x,rows:v,columnHeaderClassNames:"py-2"})})]})}):y?s.j.jsx("div",{className:"text-center",children:t.dataFetchingError||t.metadataFetchingError}):s.j.jsx(s.j.Fragment,{children:s.j.jsxs("div",{className:"text-center",children:[s.j.jsx("div",{children:"Fetching"})," ",s.j.jsx(s.S,{classNames:"w-4 h-4 text-gray-500"})]})})})})}function x({availableDbs:e=[],onSelectDb:t=(...e)=>{},onParseCsv:a=(...e)=>{},fileUploading:l=!1}){let i=(0,r.useContext)(s.M);return s.j.jsxs("div",{className:"w-full h-full flex flex-col gap-4 items-center justify-center",children:[s.j.jsx(s.b,{rootClassNames:"w-96 max-w-[90%] border p-4 rounded-md",label:"Please select a database",options:e.map(e=>(e.value=e.name,e.label=e.name,e)),disabled:l,onChange:e=>{t(e)}}),s.j.jsx(o.a,{label:"Or drop a CSV",rootClassNames:"w-96 max-w-[90%] border p-4 rounded-md text-gray-400",disabled:l,onFileSelect:e=>{e.preventDefault(),e.stopPropagation();try{let t=e.target.files[0];if(!t||"text/csv"!==t.type)throw Error("Only CSV files are accepted");(0,s.p)(t,a)}catch{i.error("Failed to parse the file")}},onDrop:e=>{var t,l;e.preventDefault(),e.stopPropagation();try{let r=null==(l=null==(t=null==e?void 0:e.dataTransfer)?void 0:t.items)?void 0:l[0];if(!r||!r.kind||"file"!==r.kind||"text/csv"!==r.type)throw Error("Only CSV files are accepted");r=r.getAsFile(),(0,s.p)(r,a)}catch(n){i.error("Failed to parse the file"),console.log(n.stack)}},showIcon:!1,children:l?s.j.jsxs("div",{className:"text-sm",children:["Uploading",s.j.jsx(s.S,{classNames:"h-4 w-4 inline m-0 ml-2 text-gray-400"})]}):s.j.jsxs(s.j.Fragment,{children:[s.j.jsx("span",{className:"inline sm:hidden",children:"Upload a CSV"}),s.j.jsx(n.F,{className:"h-6 w-6 inline text-gray-400"})]})})]})}function v({csvFileKeyName:e=null,uploadedCsvPredefinedQuestions:t=["Show me any 5 rows"],dbs:a,searchBarDraggable:n=!0,searchBarClasses:i="",limitCsvUploadSize:d=!0,maxCsvUploadSize:c=10,uploadedCsvIsSqlOnly:u=!0}){let m=(0,r.useContext)(s.M),h=(0,r.useContext)(l.A),{sqliteConn:v,token:j,apiEndpoint:w}=h.val,[A,N]=(0,r.useState)(a),[C,_]=(0,r.useState)(null),k=(0,r.useMemo)(()=>A.find(e=>e.name===C),[C,A]),E=(0,r.useMemo)(()=>{var e;return null==(e=A.find(e=>e.name===C))?void 0:e.keyName},[C,A]),S=(0,r.useMemo)(()=>{var e;return(null==(e=A.find(e=>e.name===C))?void 0:e.metadata)||null},[C,A]),I=(0,r.useMemo)(()=>{var e;return(null==(e=A.find(e=>e.name===C))?void 0:e.sqlOnly)||!1},[C,A]),T=(0,r.useMemo)(()=>{var e;return(null==(e=A.find(e=>e.name===C))?void 0:e.isTemp)||!1},[C,A]),M=(0,r.useMemo)(()=>{var e;return null==(e=A.find(e=>e.name===C))?void 0:e.analysisTreeManager},[C,A]),O=(0,r.useMemo)(()=>{var e;return(null==(e=A.find(e=>e.name===C))?void 0:e.predefinedQuestions)||[]},[C,A]),[F,D]=(0,r.useState)(!1),R=async({file:a,columns:l,rows:r})=>{try{if(!v)throw Error("SQLite connection not initialized. Please refresh the page and try again. If the error persists, please reach out to us.");if(D(!0),d&&a.size>1048576*c)throw Error("File size is too large. Max size allowed is 10MB.");let n=a.name.split(".")[0];A.find(e=>e.name===n)&&(n=n+"_"+Math.floor(1e3*Math.random()));let i=(0,s.c)("csv_"+n),o=null,h=null;if(v)try{let{columnMetadata:f,fiveRowsAsArraysOfValues:g}=(0,s.d)({conn:v,tableName:i,rows:r,columns:l});m.info("CSV parsed, now generating descriptions for columns!"),o={[i]:{data:g,columns:f.map(e=>e.dataIndex)}};let p=f.filter(e=>e.hasMultipleTypes);p.length>0&&m.warning(`Columns ${p.map(e=>`'${e.title}'`).join(",")} have values of multiple data types. This might cause issues.`),h=f.map(e=>({column_name:e.dataIndex,table_name:i,data_type:e.dataType}));let b=await (0,s.g)({apiEndpoint:w,keyName:e,metadata:h,tableName:i});if(!b.success||b.error_message||!b.descriptions)throw Error(b.error_message||"Failed to get column descriptions. Queries might be less precise.");let x=b.descriptions;h.forEach(e=>{let t=x.find(t=>t.column_name===e.column_name);t&&(e.column_description=t.column_description)})}catch(j){console.log(j.stack),m.error(j.message)}N(a=>{let s=[...a],r={name:n,keyName:e,isTemp:!0,sqlOnly:u&&!0,metadata:h||null,data:Object.assign({},o||{}),columns:l,sqliteTableName:i,metadataFetchingError:!h&&"Error fetching metadata",predefinedQuestions:t,analysisTreeManager:y({},"csv_"+Math.floor(1e3*Math.random()))};return s.push(r),s}),_(n)}catch(C){console.log(C.stack),m.error(C.message)}finally{D(!1)}},q=(0,r.useMemo)(()=>s.j.jsx(x,{availableDbs:A,onSelectDb:e=>_(e),fileUploading:F,onParseCsv:R}),[A,F]),P=(0,r.useMemo)(()=>[{name:"Analysis",headerClassNames:(e,t)=>(0,s.t)("bg-gray-100","Analysis"===t.name&&e?"bg-gray-600 text-white hover:bg-gray-600":""),content:M&&E&&j&&w?s.j.jsx(p,{predefinedQuestions:O,isTemp:T,keyName:E,treeManager:M,forceSqlOnly:I,metadata:S,searchBarDraggable:n,searchBarClasses:i}):q},{name:"View data structure",content:k?s.j.jsx(g,{apiEndpoint:w,db:k,token:j,onGetMetadata:({metadata:e,error:t})=>{N(a=>{let l=[...a],s=a.findIndex(e=>e.name===C);return s<0||(l[s]=Object.assign({},l[s]),k.isTemp&&e.forEach(e=>{e.sqlite_table_name=k.sqliteTableName}),l[s].metadata=e,t&&(l[s].metadataFetchingError=t,l[s].data={},l[s].dataFetchingError=t||!1)),l})}},E):q},{name:"Preview data",content:k?s.j.jsx(b,{apiEndpoint:w,db:k,token:j,onGetData:({data:e})=>{N(t=>{let a=[...t],l=t.findIndex(e=>e.name===C);return l<0||(a[l]=Object.assign({},a[l]),a[l].data=Object.assign({},e)),a})}},E):q}],[k,w,n,j,q]);return(0,r.useEffect)(()=>{k&&(k.isTemp?h.update({...h.val,isTemp:!0,sqlOnly:!0,keyName:k.keyName,metadata:k.metadata}):h.update({...h.val,isTemp:!1,sqlOnly:!1,keyName:k.keyName,metadata:k.metadata}))},[k]),s.j.jsx(f,{defaultSelectedDb:C,availableDbs:A.map(e=>e.name),onDbChange:e=>_(e),onParseCsv:R,rootClassNames:e=>"flex flex-col "+(e?"":"items-center justify-center"),fileUploading:F,children:s.j.jsx(o.T,{disableSingleSelect:!0,vertical:!0,rootClassNames:"grow h-[90%] w-full",contentClassNames:"mt-2 sm:mt-0 bg-white grow overflow-hidden shadow-custom rounded-2xl sm:rounded-tl-none",defaultTabClassNames:"pl-0 sm:mt-0 h-full",selectedTabHeaderClasses:e=>"Analysis"===e?"bg-transparent":"",tabs:P})})}function j({token:e,apiEndpoint:t="https://demo.defog.ai",user:a="admin",devMode:n=!1,showAnalysisUnderstanding:i=!0,showCode:o=!1,allowDashboardAdd:d=!0,disableMessages:c=!1,dbs:u=[],uploadedCsvIsSqlOnly:m=!0,uploadedCsvPredefinedQuestions:h=["Show me any 5 rows"],searchBarDraggable:f=!0,searchBarClasses:g="",csvFileKeyName:p=null,limitCsvUploadSize:b=!0,maxCsvUploadSize:x=10}){let j=(0,r.useMemo)(()=>u.map(e=>({isTemp:!1,sqlOnly:!1,metadata:null,data:{},metadataFetchingError:!1,analysisTreeManager:y({},e.keyName+"_"+Math.floor(1e3*Math.random())),...e})),[u]);return s.j.jsx("div",{className:"w-full bg-gradient-to-br from-[#6E00A2]/10 to-[#FFA20D]/10 px-2 lg:px-0 py-8 h-screen flex items-center shadow-inner relative",children:s.j.jsx("div",{className:"w-full lg:w-10/12 min-h-96 h-[95%] overflow-y-hidden mx-auto",children:s.j.jsx(l.S,{token:e,user:a,apiEndpoint:t,devMode:n,showAnalysisUnderstanding:i,showCode:o,allowDashboardAdd:d,disableMessages:c,children:s.j.jsx(v,{uploadedCsvIsSqlOnly:m,dbs:j,uploadedCsvPredefinedQuestions:h,searchBarClasses:g,searchBarDraggable:f,csvFileKeyName:p||(u.length>0?u[0].keyName:null),limitCsvUploadSize:b,maxCsvUploadSize:x})})})})}}}]);