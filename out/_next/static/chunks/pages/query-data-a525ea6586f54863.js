(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[137],{20328:function(e,t,l){(window.__NEXT_P=window.__NEXT_P||[]).push(["/query-data",function(){return l(46249)}])},26335:function(e,t,l){"use strict";var r=l(28598),n=l(1887),i=l.n(n);t.Z=()=>(0,r.jsxs)(i(),{children:[(0,r.jsx)("title",{children:"Defog.ai - AI Assistant for Data Analysis"}),(0,r.jsx)("meta",{name:"description",content:"Train your AI data assistant on your own device"}),(0,r.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1"}),(0,r.jsx)("link",{rel:"icon",href:"/favicon.ico"})]})},82067:function(e,t,l){"use strict";var r=l(28598),n=l(82684),i=l(97574),o=l(79869),d=l(34376);l(12691);var c=l(26978),u=l(47663),m=l(56572);t.Z=e=>{let{id:t,userType:l,children:h,rootClassNames:g="",contentClassNames:y=""}=e,{Content:p,Sider:v}=o.Layout,[j,N]=(0,n.useState)([]),[A,C]=(0,n.useContext)(i.S),k=(0,d.useRouter)(),redirect=e=>{k.push(e)},logout=()=>{localStorage.removeItem("defogUser"),localStorage.removeItem("defogToken"),localStorage.removeItem("defogUserType"),C({user:null,token:null,userType:null}),redirect("/static/log-in.html")},S=(0,u.usePathname)();(0,n.useEffect)(()=>{N(("admin"==l?[{key:"manage-database",title:"Manage Database",href:"/static/extract-metadata.html"},{key:"manage-users",title:"Manage Users",href:"/static/manage-users.html"},{key:"manage-tools",title:"Manage tools",href:"/static/manage-tools.html"},{key:"check-readiness",title:"Check Readiness",href:"/static/check-readiness.html"},{key:"align-model",title:"Align Model",href:"/static/align-model.html"},{key:"view-feedback",title:"View Feedback",href:"/static/view-feedback.html"},{key:"query-data",title:"Query Data",href:"/static/query-data.html"},{key:"logout",classNames:"self-end",title:"Logout",href:"#",onClick:logout}]:l?[{key:"query-data",title:"Query Data",href:"/static/query-data.html"},{key:"logout",classNames:"self-end",title:"Logout",href:"#",onClick:logout}]:[]).map(e=>(e.current=e.href==S,e)))},[l]);let[I,E]=(0,n.useState)("flex flex-col md:min-h-screen relative container mx-auto");return(0,n.useEffect)(()=>{"/query-data"===S&&E("flex flex-col md:min-h-screen relative")},[S]),(0,r.jsxs)("div",{className:(0,m.m6)(I,g),children:[j.length?(0,r.jsx)(c.l2,{rootClassNames:"border-b",items:j}):(0,r.jsx)(r.Fragment,{}),(0,r.jsx)("div",{className:(0,m.m6)("grow",y),children:h})]})}},46249:function(e,t,l){"use strict";l.r(t),l.d(t,{default:function(){return query_data}});var r=l(28598),n=l(82684),i=l(26335),o=l(82067),d=l(26978),c=l(27843),u=l(64050),m=l(76155),h=l(82225),g=l(13013);let y=n.forwardRef(function({title:e,titleId:t,...l},r){return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:r,"aria-labelledby":t},l),e?n.createElement("title",{id:t},e):null,n.createElement("path",{fillRule:"evenodd",d:"M17 4.25A2.25 2.25 0 0 0 14.75 2h-5.5A2.25 2.25 0 0 0 7 4.25v2a.75.75 0 0 0 1.5 0v-2a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v11.5a.75.75 0 0 1-.75.75h-5.5a.75.75 0 0 1-.75-.75v-2a.75.75 0 0 0-1.5 0v2A2.25 2.25 0 0 0 9.25 18h5.5A2.25 2.25 0 0 0 17 15.75V4.25Z",clipRule:"evenodd"}),n.createElement("path",{fillRule:"evenodd",d:"M1 10a.75.75 0 0 1 .75-.75h9.546l-1.048-.943a.75.75 0 1 1 1.004-1.114l2.5 2.25a.75.75 0 0 1 0 1.114l-2.5 2.25a.75.75 0 1 1-1.004-1.114l1.048-.943H1.75A.75.75 0 0 1 1 10Z",clipRule:"evenodd"}))}),p=n.forwardRef(function({title:e,titleId:t,...l},r){return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:r,"aria-labelledby":t},l),e?n.createElement("title",{id:t},e):null,n.createElement("path",{d:"m13.28 7.78 3.22-3.22v2.69a.75.75 0 0 0 1.5 0v-4.5a.75.75 0 0 0-.75-.75h-4.5a.75.75 0 0 0 0 1.5h2.69l-3.22 3.22a.75.75 0 0 0 1.06 1.06ZM2 17.25v-4.5a.75.75 0 0 1 1.5 0v2.69l3.22-3.22a.75.75 0 0 1 1.06 1.06L4.56 16.5h2.69a.75.75 0 0 1 0 1.5h-4.5a.747.747 0 0 1-.75-.75ZM12.22 13.28l3.22 3.22h-2.69a.75.75 0 0 0 0 1.5h4.5a.747.747 0 0 0 .75-.75v-4.5a.75.75 0 0 0-1.5 0v2.69l-3.22-3.22a.75.75 0 1 0-1.06 1.06ZM3.5 4.56l3.22 3.22a.75.75 0 0 0 1.06-1.06L4.56 3.5h2.69a.75.75 0 0 0 0-1.5h-4.5a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 1.5 0V4.56Z"}))});function le({setActiveAnalysisId:e,setActiveRootAnalysisId:t,setAddToDashboardSelection:l=(...e)=>{},analysis:r=null,isActive:i=!1,extraClasses:o="",isDummy:d=!1,onClick:m=()=>{}}){let h=(0,n.useContext)(c.A);return u.j.jsxs("div",{className:(0,u.t)("flex flex-row items-center py-1 px-2 mb-2 hover:cursor-pointer hover:bg-gray-200 history-item",i?"font-bold bg-gray-200 ":"",d?"dummy-analysis":r.analysisId,o),onClick:()=>{t(null==r?void 0:r.rootAnalysisId),e(null==r?void 0:r.analysisId),m()},children:[u.j.jsx("div",{className:"grow",children:d?"New analysis":(0,u.s)(null==r?void 0:r.user_question)}),!d&&h.val.allowDashboardAdd&&u.j.jsx("div",{className:"rounded-sm hover:bg-blue-500 p-1 flex justify-center group ",onClick:()=>{e(null==r?void 0:r.analysisId),l(r)},children:u.j.jsx(c.F,{className:"h-4 w-4 text-gray-400 group-hover:text-white"})})]})}let Te=({analyses:e,activeAnalysisId:t})=>{let[l,r]=(0,n.useState)([]),i=(0,n.useRef)(null);return(0,n.useEffect)(()=>{if(!i.current)return;if(!t){l.length>0&&r([]);return}let n=i.current.closest(".history-list");if(!n)return;n.querySelectorAll(".linked-active").forEach(e=>{e.classList.remove("linked-active")}),n.querySelectorAll(".current-active").forEach(e=>{e.classList.remove("current-active")});let o=n.querySelector(`.${t}`);o&&o.classList.add("current-active");let d=e[t],c=[],u=[];for(;c.length<20&&!d.isRoot;){let t=e[d.directParentId];c.push(t);let l=n.getBoundingClientRect(),r=n.querySelector(`.${d.analysisId}`),i=n.querySelector(`.${t.analysisId}`),o=r.getBoundingClientRect(),m=i.getBoundingClientRect(),h={x:o.left-l.left-8,y:o.top-l.top+o.height/2},g={x:m.left-l.left-8,y:m.top-l.top+m.height/2},y=g.y-h.y,p=g.x-(h.x-10),v=`M ${h.x} ${h.y} l -10 0 l 0 ${y} l ${p} 0`;u.push(v),d=t}c.forEach(e=>{let t=n.querySelector(`.${e.analysisId}`);t&&t.classList.add("linked-active")}),r(u)},[e,t]),u.j.jsx("div",{className:"absolute l-0 t-0 pointer-events-none overflow-visible",ref:i,children:u.j.jsx("svg",{width:"100%",height:"100%",className:"overflow-visible",children:l.map((e,t)=>u.j.jsx("path",{d:e,className:"fill-transparent stroke-blue-300 text-blue-500",strokeWidth:"1"},t))})})};function Re({analysisTreeManager:e,keyName:t,isTemp:l=!1,forceSqlOnly:r=!1,metadata:i=null,predefinedQuestions:o=[],autoScroll:d=!0,sideBarClasses:g="",searchBarClasses:v="",searchBarDraggable:j=!0,defaultSidebarOpen:N=!1,showToggle:A=!0}){var C;let k=(0,n.useContext)(u.M),S=(0,u.u)(),I=(0,n.useRef)({}),[E,_]=(0,n.useState)(!1),[T,M]=(0,n.useState)(r),F=(0,n.useRef)(null),D=(0,n.useRef)(null),[O,q]=(0,n.useState)(!1),[R,P]=(0,n.useState)([]),{dashboards:L}=(0,n.useContext)(c.A).val,[B,U]=(0,n.useState)(N),Q=(0,m.u)(),V=(0,n.useSyncExternalStore)(e.subscribeToDataChanges,e.getTree),$=(0,n.useSyncExternalStore)(e.subscribeToDataChanges,e.getAll),W=(0,n.useSyncExternalStore)(e.subscribeToActiveAnalysisIdChanges,e.getActiveAnalysisId),Z=(0,n.useSyncExternalStore)(e.subscribeToActiveAnalysisIdChanges,e.getActiveRootAnalysisId);(0,n.useEffect)(()=>{_(!1),P([]),q(!1),I.current={}},[e]);let H=(0,n.useCallback)(async function(n,i=null,o=!1,d=null){try{if(!e)throw Error("Analysis tree manager not found");_(!0);let{newId:c,newAnalysis:u}=await e.submit({question:n,rootAnalysisId:i,keyName:t,isRoot:o,directParentId:d,sqlOnly:r||T,isTemp:l});i||e.setActiveRootAnalysisId(u.analysisId),e.setActiveAnalysisId(u.analysisId),e.setActiveRootAnalysisId(u.rootAnalysisId),D.current.value=""}catch(e){k.error("Failed to create analysis"),console.log(e.stack)}finally{_(!1)}},[e,r,T,l,t,i]);function z(e){var t,l;null!=(l=null==(t=I.current)?void 0:t[e])&&l.ctr&&I.current[e].ctr.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}return(0,n.useEffect)(()=>{if(j)return a(),window.addEventListener("resize",a),()=>{window.removeEventListener("resize",a)};function a(){F.current&&(F.current.style.left="0",F.current.style.right="0",F.current.style.bottom=window.innerWidth>1600?"30%":"20px")}},[j]),window.ref=D,u.j.jsxs(c.E,{children:[u.j.jsxs("div",{className:"relative h-full",children:[W&&Z&&u.j.jsx("div",{className:"lg:hidden absolute bottom-0 left-0 w-full h-[10%] pointer-events-none bg-gradient-to-b from-transparent to-gray-300 z-10"}),u.j.jsxs("div",{className:"analysis-tree-viewer max-w-full h-full flex flex-row bg-white text-gray-600 w-full",children:[u.j.jsx("div",{className:"absolute h-full left-0 top-0 z-[20] lg:sticky lg:h-full",children:u.j.jsx(h.S,{location:"left",open:B,onChange:e=>{U(e)},title:u.j.jsx("span",{className:"font-bold",children:"History"}),rootClassNames:(0,u.t)("transition-all z-20 h-[calc(100%-1rem)] rounded-md rounded-l-none lg:rounded-none lg:rounded-tr-md lg:rounded-br-md bg-gray-100 border-r sticky top-0 lg:relative",g),iconClassNames:`${B?"":"text-white bg-secondary-highlight-2"}`,openClassNames:"border-gray-300 shadow-md",closedClassNames:"border-transparent bg-transparent shadow-none",contentClassNames:"w-72 px-2 pt-5 pb-14 rounded-tl-lg relative sm:block pl-4 min-h-96 h-full overflow-y-auto",children:u.j.jsxs("div",{className:"flex flex-col text-sm relative history-list",children:[u.j.jsx(Te,{analyses:$,activeAnalysisId:null!=$&&$[W]?W:null}),Object.keys(V).map((t,l)=>{var r;let n=V[t].root,i=(null==(r=null==V?void 0:V[t])?void 0:r.analysisList)||[];return u.j.jsx("div",{className:"",children:i.map((t,l)=>u.j.jsx(le,{analysis:t,isActive:W===t.analysisId,setActiveRootAnalysisId:e.setActiveRootAnalysisId,setActiveAnalysisId:e.setActiveAnalysisId,setAddToDashboardSelection:q,onClick:()=>{d&&z(t.analysisId),Q[0]<m.b.lg&&U(!1)},extraClasses:t.isRoot?"":"ml-2 border-l-2"},t.analysisId))},n.analysisId)}),Z?u.j.jsxs("div",{className:"w-full mt-5 sticky bottom-5",children:[u.j.jsxs("div",{"data-enabled":!E,className:(0,u.t)("flex items-center cursor-pointer z-20 relative","data-[enabled=true]:bg-blue-200 data-[enabled=true]:hover:bg-blue-500 data-[enabled=true]:hover:text-white p-2 data-[enabled=true]:text-blue-400 data-[enabled=true]:shadow-custom ","data-[enabled=false]:bg-gray-100 data-[enabled=false]:hover:bg-gray-100 data-[enabled=false]:hover:text-gray-400 data-[enabled=false]:text-gray-400 data-[enabled=false]:cursor-not-allowed"),onClick:()=>{E||(e.setActiveRootAnalysisId(null),e.setActiveAnalysisId(null),Q[0]<m.b.lg&&U(!1))},children:["New ",u.j.jsx(c.F,{className:"ml-2 w-4 h-4 inline"})]}),u.j.jsx("div",{className:"absolute w-full h-10 bg-gray-100 z-0"})]}):u.j.jsx(le,{isDummy:!0,setActiveRootAnalysisId:e.setActiveRootAnalysisId,setActiveAnalysisId:e.setActiveAnalysisId,isActive:!Z})]})})}),u.j.jsx("div",{className:(0,u.t)("absolute left-0 top-0 h-full w-full overlay lg:hidden bg-gray-800 z-[11] transition-all",B?"opacity-50 block":"opacity-0 pointer-events-none"),onClick:()=>{U(!1)}}),u.j.jsxs("div",{className:"grid grid-cols-1 pt-10 sm:pt-0 auto-cols-max lg:grid-cols-1 grow rounded-tr-lg p-2 lg:p-4 relative min-w-0 h-full overflow-scroll",children:[Z&&(null==(C=null==V?void 0:V[Z])?void 0:C.analysisList)&&V[Z].analysisList.map(t=>u.j.jsx(c.a,{metadata:i,rootClassNames:"w-full mb-4 [&_.analysis-content]:min-h-96 shadow-md analysis-"+t.analysisId,analysisId:t.analysisId,createAnalysisRequestBody:t.createAnalysisRequestBody,initiateAutoSubmit:!0,hasExternalSearchBar:!0,setGlobalLoading:_,sqlOnly:t.sqlOnly,isTemp:t.isTemp,keyName:t.keyName,onManagerCreated:(l,r,n)=>{I.current[r]={ctr:n,analysisManager:l,id:r},d&&z(r),e.updateAnalysis({analysisId:t.analysisId,isRoot:t.isRoot,updateObj:{analysisManager:l}})},onManagerDestroyed:(l,r)=>{e.removeAnalysis({analysisId:t.analysisId,isRoot:t.isRoot,rootAnalysisId:t.rootAnalysisId}),e.setActiveAnalysisId(null),Z===r&&e.setActiveRootAnalysisId(null),_(!1)},initialConfig:{analysisManager:t.analysisManager||null}},t.analysisId)),!W&&u.j.jsx("div",{className:" grow flex flex-col place-content-center m-auto max-w-full relative z-[1]",children:u.j.jsxs("div",{className:"text-gray-400 text-center rounded-md",children:[u.j.jsx("p",{className:"cursor-default block text-sm mb-4 font-bold",children:"Quickstart"}),u.j.jsx("ul",{className:"text-gray-500 font-light",children:o.map((e,t)=>u.j.jsx("li",{className:"",children:u.j.jsx("button",{className:(0,u.t)("cursor-pointer text-sm p-2 m-1 border border-gray-200 rounded-md shadow-sm",E?"bg-gray-100 text-gray-300 cursor-not-allowed":"hover:bg-gray-50 hover:border"),onClick:t=>{E||H((0,u.s)(e),Z,!Z,W)},children:(0,u.s)(e)})},t))})]})}),u.j.jsxs("div",{className:(0,u.t)("w-full lg:w-8/12 m-auto fixed z-20 bg-white rounded-lg shadow-custom border border-gray-400 hover:border-blue-500 focus:border-blue-500 flex flex-row",v),style:{left:"0",right:"0",bottom:j?window.innerWidth>1600?"30%":"20px":null},ref:F,children:[j&&u.j.jsx("div",{className:"cursor-move min-h-full w-3 flex items-center ml-1 group",draggable:j,onDragStart:e=>{j&&e.dataTransfer.setDragImage(S,0,0)},onDrag:e=>{if(!j||!e.clientX||!e.clientY||!F.current)return;let t=window.innerHeight-e.clientY-F.current.clientHeight,l=e.clientX,r=window.innerHeight-20-F.current.clientHeight;t<20?F.current.style.bottom="20px":t>r?F.current.style.bottom=r+"px":F.current.style.bottom=t+"px";let n=window.innerWidth-F.current.clientWidth-20;F.current.style.right="auto",l<20?F.current.style.left="20px":l>n?F.current.style.left=n+"px":F.current.style.left=l+"px"},children:u.j.jsx(p,{className:"h-3 w-3 text-gray-400 group-hover:text-primary-text"})}),u.j.jsx("div",{className:"grow rounded-md lg:items-center flex flex-col-reverse lg:flex-row",children:u.j.jsxs("div",{className:"flex flex-row grow",children:[u.j.jsxs("div",{className:"flex lg:flex-row-reverse lg:items-center flex-col grow",children:[u.j.jsx(u.T,{rootClassNames:"grow border-none bg-transparent py-1.5 text-gray-900 px-2 placeholder:text-gray-400 sm:leading-6 text-sm break-all focus:ring-0 focus:outline-none",textAreaClassNames:"resize-none",ref:D,disabled:E,defaultRows:1,onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),e.stopPropagation(),H(D.current.value,Z,!Z,W))},placeholder:Z?"Type your next question here":"Type your question here"}),A&&u.j.jsx(h.T,{disabled:r||E,titleClassNames:"font-bold text-gray-400",onToggle:e=>{r||M(!e)},defaultOn:!T,offLabel:"Advanced",onLabel:"Advanced",rootClassNames:"items-start lg:border-r py-2 lg:py-0 px-2 w-32"})]}),u.j.jsxs("button",{type:"button",className:"relative -ml-px inline-flex items-center gap-x-1.5 rounded-r-md px-3 p-0 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-blue-500 hover:bg-blue-500 hover:text-white",onClick:()=>{H(D.current.value,Z,!Z,W)},children:[u.j.jsx(y,{className:"-ml-0.5 h-5 w-5 text-gray-400","aria-hidden":"true"}),"Ask"]})]})})]})]})]})]}),u.j.jsx(c.M,{title:"Select the dashboards to add this analysis to",open:O,onOk:()=>{},onCancel:()=>{q(!1)},children:u.j.jsx("div",{className:"dashboard-selection mt-8 flex flex-col max-h-80 overflow-scroll bg-gray-100 rounded-md",children:L.map(e=>u.j.jsxs("div",{className:"flex flex-row p-2 hover:bg-gray-200 cursor-pointer text-gray-400 items-start "+(R.includes(e.doc_id)&&"text-gray-600 font-bold"),onClick:()=>{R.includes(e.doc_id)?P(R.filter(t=>t!==e.doc_id)):P([...R,e.doc_id])},children:[u.j.jsx("div",{className:"checkbox mr-3",children:u.j.jsx("input",{className:"appearance-none w-3 h-3 border border-gray-300 rounded-md checked:bg-blue-600 checked:border-transparent",type:"checkbox",checked:R.includes(e.doc_id),readOnly:!0})}),u.j.jsx("div",{className:"grow",children:e.doc_title})]},e.doc_id))})})]})}function Oe({rootClassNames:e=e=>"",availableDbs:t=[],defaultSelectedDb:l=null,allowUploadFile:r=!0,onDbChange:i=(...e)=>{},children:o=null,fileUploading:d=!1,onParseCsv:c=(...e)=>{}}){let[h,y]=(0,n.useState)(l),[p,v]=(0,n.useState)(!1),j=(0,n.useContext)(u.M);return(0,n.useEffect)(()=>{y(l)},[l]),u.j.jsxs("div",{className:(0,u.t)("w-full h-full p-2","function"==typeof e?e(h):""),children:[u.j.jsxs("div",{className:"w-full relative mb-4 text-gray-500 text-xs flex flex-row",children:[u.j.jsx("div",{className:"h-full mr-2 font-bold z-10 whitespace-nowrap py-2",children:"Dataset:"}),u.j.jsx("div",{className:"overflow-scroll flex flex-row gap-2 px-2 items-center rounded-md",children:t.map((e,t)=>u.j.jsx("span",{onClick:()=>{d||(y(e),i(e))},className:(0,u.t)("p-2 bg-gray-200 border border-gray-300 rounded-full cursor-pointer whitespace-nowrap",h===e?"bg-gray-600 border-transparent text-white":"hover:bg-gray-300",d?"cursor-not-allowed bg-gray-200 text-gray-400 hover:bg-gray-200":""),children:e},e+"-"+t))}),u.j.jsx("div",{className:"self-end ml-auto pl-3",children:r&&u.j.jsx(g.D,{rootClassNames:"flex items-center cursor-pointer group ml-auto self-end",disabled:d,onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),v(!0),console.log(e.target)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),v(!1)},onFileSelect:e=>{try{let t=e.target.files[0];if(!t)return;if("text/csv"!==t.type)throw Error("Only CSV files are accepted");(0,u.p)(t,c)}catch(e){j.error(e.message||"Only CSV files are accepted."),v(!1)}},onDrop:e=>{var t,l;console.log("here"),e.preventDefault();try{let r=null==(l=null==(t=null==e?void 0:e.dataTransfer)?void 0:t.items)?void 0:l[0];if(console.log(r),!r)return;if(!r.kind||"file"!==r.kind||"text/csv"!==r.type)throw Error("Only CSV files are accepted");r=r.getAsFile(),(0,u.p)(r,c)}catch(e){j.error(e.message||"Failed to parse the file"),console.log(e.stack),v(!1)}},children:u.j.jsx("span",{className:(0,u.t)("rounded-full cursor-pointe p-2 flex items-center whitespace-nowrap",d?"bg-gray-200 text-gray-400":"bg-secondary-highlight-1/40 text-white group-hover:bg-secondary-highlight-1 group-hover:text-white"),children:d?u.j.jsxs(u.j.Fragment,{children:["Uploading",u.j.jsx(u.S,{classNames:"h-4 w-4 inline m-0 ml-2 text-gray-500"})]}):u.j.jsxs(u.j.Fragment,{children:[u.j.jsx("span",{className:"hidden sm:inline",children:p?"Drop here!":"Upload / Drop a CSV"}),u.j.jsx("span",{className:"inline sm:hidden",children:"Upload a CSV"}),u.j.jsx(m.F,{className:"h-4 w-4 inline ml-1"})]})})})})]}),o]})}function ue(e={},t=(0,u.v)()){let l=e,r=Object.values(l).reduce((e,t)=>({...e,[t.root.analysisId]:t.root,...t.analysisList.reduce((e,t)=>({...e,[t.analysisId]:t}),{})}),{}),n=[],i=[],o=null,d=null;function f(e,t){l=e,r=t,n.forEach(e=>e())}function s(){i.forEach(e=>e())}return{subscribeToDataChanges:function(e){return n=[...n,e],function(){n=n.filter(t=>t!==e)}},getTree:function(){return l},getAll:function(){return r},subscribeToActiveAnalysisIdChanges:function(e){return i.push(e),function(){i=i.filter(t=>t!==e)}},setActiveAnalysisId:function(e){o=e,s()},setActiveRootAnalysisId:function(e){d=e,s()},getActiveAnalysisId:function(){return o},getActiveRootAnalysisId:function(){return d},submit:async function({question:e,keyName:t,rootAnalysisId:n=null,isRoot:i=!1,directParentId:o=null,sqlOnly:d=!1,isTemp:c=!1}){let m="analysis-"+(0,u.v)(),h={analysisId:m,isRoot:i,rootAnalysisId:i?m:n,user_question:e,existingAnalysisData:null,isTemp:c,keyName:t,sqlOnly:d};h.directParentId=o,h.createAnalysisRequestBody={other_data:{user_question:e,is_root_analysis:i,root_analysis_id:n,direct_parent_id:o},sql_only:d};let g={...l};if(n){let e=l[n].root;g[e.analysisId].analysisList.push(h)}else g[h.analysisId]={root:h,analysisList:[h]};let y={...r,[h.analysisId]:h};return f(g,y),{newId:m,newAnalysis:h}},removeAnalysis:function({analysisId:e,isRoot:t,rootAnalysisId:n}){let i={...l};if(t)delete i[e];else if(n){let t=i[n];t&&(t.analysisList=t.analysisList.filter(t=>t.analysisId!==e))}let o={...r};delete o[e],f(i,o)},updateAnalysis:function({analysisId:e,isRoot:t,updateObj:n,emit:i=!0}){let o={...l};if(!r[e]){console.warn("Analysis not found",e);return}t&&(o[e].root={...o[e].root,...n});let d=r[e].rootAnalysisId;o[d].analysisList=o[d].analysisList.map(t=>t.analysisId===e?{...t,...n}:t);let c={...r};c[e]={...c[e],...n},f(o,c)},getMgrId:()=>t,reset:function(){f({},{})}}}function Le({apiEndpoint:e=null,db:t=null,token:l=null,onGetMetadata:r=(...e)=>{}}){let i=(0,n.useContext)(u.M),{keyName:o,metadata:d,isTemp:m}=t||{};(0,n.useEffect)(()=>{if(!t)return;let n=!!t.metadata;async function b(){let t;if(!e||!o||!l){i.error("Failed to get metadata");return}try{if((t=await (await fetch(`${e}/integration/get_metadata`,{signal:AbortSignal.timeout(1e4),method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({token:l,key_name:o,temp:m})})).json()).error)throw Error(t.error)}catch(e){console.log(e),i.error("Error getting metadata: "+t.error),t={error:t.error||"Error fetching metadata."}}finally{r(t)}}n||t.metadataFetchingError||b()},[t]);let h=(0,n.useMemo)(()=>Array.isArray(d)&&!t.metadataFetchingError?Array.from(new Set(d.map(e=>e.table_name))):[],[d,t]),y=Array.isArray(d)&&!t.metadataFetchingError?[{dataIndex:"table_name",title:"table_name",key:"table_name"},{dataIndex:"column_name",title:"column_name",key:"column_name"},{dataIndex:"column_description",title:"column_description",key:"column_description"},{dataIndex:"data_type",title:"data_type",key:"data_type"}]:[],[p,v]=(0,n.useState)(h);(0,n.useEffect)(()=>{v(h)},[o+h.join(",")]);let j=Array.isArray(d)&&!t.metadataFetchingError?d.filter(e=>0===p.length||p.includes(e.table_name)):[];return u.j.jsx(c.E,{children:u.j.jsx("div",{className:(0,u.t)("p-2 w-full h-full flex ",Array.isArray(d)&&!t.metadataFetchingError?"flex-col items-start justify-start":"items-center justify-center"),children:Array.isArray(d)&&!t.metadataFetchingError?u.j.jsx(u.j.Fragment,{children:u.j.jsxs("div",{className:"flex flex-col justify-center w-full",children:[u.j.jsx("div",{className:"py-2 border-b bg-white sticky top-2 mb-3 z-[20]",children:u.j.jsx(g.M,{rootClassNames:"max-w-full",placeholder:"Filter tables",value:[],options:h.map(e=>({label:e,value:e})),onChange:e=>{v(e)},allowCreateNewOption:!1})}),u.j.jsx(u.a,{pagination:{defaultPageSize:5},paginationPosition:"top",rootClassNames:"rounded-md max-w-full",columns:y,rows:j,columnHeaderClassNames:"py-2"})]})}):u.j.jsx("div",{className:"text-center",children:t.metadataFetchingError?t.metadataFetchingError:u.j.jsxs(u.j.Fragment,{children:[u.j.jsx("div",{children:"Fetching"})," ",u.j.jsx(u.S,{classNames:"w-4 h-4 text-gray-500"})]})})})})}function qe({keyName:e,treeManager:t,predefinedQuestions:l,searchBarDraggable:r=!0,isTemp:n=!1,forceSqlOnly:i=!1,metadata:o=null,sideBarClasses:d="h-full",searchBarClasses:m="",defaultSidebarOpen:h=null}){return u.j.jsx(c.E,{children:u.j.jsx(Re,{keyName:e,metadata:o,isTemp:n,forceSqlOnly:i,analysisTreeManager:t,autoScroll:!0,sideBarClasses:d,searchBarClasses:(0,u.t)(r?"":"sticky bottom-1","[&_textarea]:pl-2",m),searchBarDraggable:r,showToggle:!i,defaultSidebarOpen:h||!(window.innerWidth<768),predefinedQuestions:l})})}function Me({apiEndpoint:e=null,db:t=null,token:l=null,onGetData:r=(...e)=>{}}){var i,o,d,m;console.log(t);let h=(0,n.useContext)(u.M),{keyName:g,isTemp:y}=t||{};(0,n.useEffect)(()=>{t&&t.metadata&&!t.metadataFetchingError&&(!t.dataFetchingError&&!t.metadataFetchingError&&t.metadata&&t.data&&Object.keys(t.data).length>0||x());async function x(){let n;let i=Array.isArray(t.metadata)&&!t.metadataFetchingError?Array.from(new Set(t.metadata.map(e=>e.table_name))):[],o={};i.forEach(async(t,d)=>{let c;o[t]={data:[],columns:[],error:!1};try{if(!e||!g||!l)throw Error("Failed to get data");if((c=await (await fetch(`${e}/integration/preview_table`,{signal:AbortSignal.timeout(1e4),method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({token:l,key_name:g,temp:y,table_name:t})})).json()).error)throw Error(c.error);c.tableName=t}catch(e){console.log(e),n=e,h.error("Error getting data: "+c.error),c={error:c.error||"Failed to fetch data.",data:[],columns:[]}}finally{o[t]={...o[t],data:c.data.slice(),columns:c.columns.slice()},d===i.length-1&&r({data:o,error:n})}})}},[t]);let p=!t.dataFetchingError&&!t.metadataFetchingError&&t.metadata&&t.data&&Object.keys(t.data).length>0,v=t.dataFetchingError||t.metadataFetchingError,j=Array.isArray(t.metadata)&&!t.metadataFetchingError?Array.from(new Set(t.metadata.map(e=>e.table_name))):[],[N,A]=(0,n.useState)(0),C=((null==(o=null==(i=null==t?void 0:t.data)?void 0:i[null==j?void 0:j[N]])?void 0:o.columns)||[]).map(e=>({dataIndex:e,key:e,title:e})),k=((null==(m=null==(d=null==t?void 0:t.data)?void 0:d[null==j?void 0:j[N]])?void 0:m.data)||[]).map(e=>{let t={};return C.forEach((l,r)=>{t[l.dataIndex]=e[r]}),t});return u.j.jsx(c.E,{children:u.j.jsx("div",{className:(0,u.t)("p-2 w-full h-full flex ",p?"":"items-center justify-center"),children:p?u.j.jsx(u.j.Fragment,{children:u.j.jsxs("div",{className:"flex flex-col py-2 relative w-full",children:[u.j.jsx("div",{className:"flex flex-row items-center mb-4 sticky top-4 z-[20] bg-white p-2 border-b",children:u.j.jsx(u.b,{value:N,onChange:e=>A(e),options:j.map((e,t)=>({value:t,label:e})),allowClear:!1,label:"Select table",allowCreateNewOption:!1})}),u.j.jsx("div",{className:"max-w-full overflow-scroll",children:u.j.jsx(u.a,{pagination:{defaultPageSize:5},paginationPosition:"top",rootClassNames:"rounded-md max-w-full",columns:C,rows:k,columnHeaderClassNames:"py-2"})})]})}):v?u.j.jsx("div",{className:"text-center",children:t.dataFetchingError||t.metadataFetchingError}):u.j.jsx(u.j.Fragment,{children:u.j.jsxs("div",{className:"text-center",children:[u.j.jsx("div",{children:"Fetching"})," ",u.j.jsx(u.S,{classNames:"w-4 h-4 text-gray-500"})]})})})})}function ze({availableDbs:e=[],onSelectDb:t=(...e)=>{},onParseCsv:l=(...e)=>{},fileUploading:r=!1}){let i=(0,n.useContext)(u.M);return u.j.jsxs("div",{className:"w-full h-full flex flex-col gap-4 items-center justify-center",children:[u.j.jsx(u.b,{rootClassNames:"w-96 max-w-[90%] border p-4 rounded-md",label:"Please select a database",options:e.map(e=>(e.value=e.name,e.label=e.name,e)),disabled:r,onChange:e=>{t(e)}}),u.j.jsx(g.a,{label:"Or drop a CSV",rootClassNames:"w-96 max-w-[90%] border p-4 rounded-md text-gray-400",disabled:r,onFileSelect:e=>{e.preventDefault(),e.stopPropagation();try{let t=e.target.files[0];if(!t||"text/csv"!==t.type)throw Error("Only CSV files are accepted");(0,u.p)(t,l)}catch{i.error("Failed to parse the file")}},onDrop:e=>{var t,r;e.preventDefault(),e.stopPropagation();try{let n=null==(r=null==(t=null==e?void 0:e.dataTransfer)?void 0:t.items)?void 0:r[0];if(!n||!n.kind||"file"!==n.kind||"text/csv"!==n.type)throw Error("Only CSV files are accepted");n=n.getAsFile(),(0,u.p)(n,l)}catch(e){i.error("Failed to parse the file"),console.log(e.stack)}},showIcon:!1,children:r?u.j.jsxs("div",{className:"text-sm",children:["Uploading",u.j.jsx(u.S,{classNames:"h-4 w-4 inline m-0 ml-2 text-gray-400"})]}):u.j.jsxs(u.j.Fragment,{children:[u.j.jsx("span",{className:"inline sm:hidden",children:"Upload a CSV"}),u.j.jsx(m.F,{className:"h-6 w-6 inline text-gray-400"})]})})]})}function Pe({csvFileKeyName:e=null,uploadedCsvPredefinedQuestions:t=["Show me any 5 rows"],dbs:l,searchBarDraggable:r=!0,searchBarClasses:i="",limitCsvUploadSize:o=!0,maxCsvUploadSize:d=10,uploadedCsvIsSqlOnly:m=!0}){let h=(0,n.useContext)(u.M),y=(0,n.useContext)(c.A),{sqliteConn:p,token:v,apiEndpoint:j}=y.val,[N,A]=(0,n.useState)(l),[C,k]=(0,n.useState)(1===l.length?l[0].name:null),S=(0,n.useMemo)(()=>N.find(e=>e.name===C),[C,N]),I=(0,n.useMemo)(()=>{var e;return null==(e=N.find(e=>e.name===C))?void 0:e.keyName},[C,N]),E=(0,n.useMemo)(()=>{var e;return(null==(e=N.find(e=>e.name===C))?void 0:e.metadata)||null},[C,N]),_=(0,n.useMemo)(()=>{var e;return(null==(e=N.find(e=>e.name===C))?void 0:e.sqlOnly)||!1},[C,N]),T=(0,n.useMemo)(()=>{var e;return(null==(e=N.find(e=>e.name===C))?void 0:e.isTemp)||!1},[C,N]),M=(0,n.useMemo)(()=>{var e;return null==(e=N.find(e=>e.name===C))?void 0:e.analysisTreeManager},[C,N]),F=(0,n.useMemo)(()=>{var e;return(null==(e=N.find(e=>e.name===C))?void 0:e.predefinedQuestions)||[]},[C,N]),[D,O]=(0,n.useState)(!1),w=async({file:l,columns:r,rows:n})=>{try{if(!p)throw Error("SQLite connection not initialized. Please refresh the page and try again. If the error persists, please reach out to us.");if(O(!0),o&&l.size>1048576*d)throw Error("File size is too large. Max size allowed is 10MB.");let i=l.name.split(".")[0];N.find(e=>e.name===i)&&(i=i+"_"+Math.floor(1e3*Math.random()));let c=(0,u.c)("csv_"+i),g=null,y=null;if(p)try{let{columnMetadata:t,fiveRowsAsArraysOfValues:l}=(0,u.d)({conn:p,tableName:c,rows:n,columns:r});h.info("CSV parsed, now generating descriptions for columns!"),g={[c]:{data:l,columns:t.map(e=>e.dataIndex)}};let i=t.filter(e=>e.hasMultipleTypes);i.length>0&&h.warning(`Columns ${i.map(e=>`'${e.title}'`).join(",")} have values of multiple data types. This might cause issues.`),y=t.map(e=>({column_name:e.dataIndex,table_name:c,data_type:e.dataType}));let o=await (0,u.g)({apiEndpoint:j,keyName:e,metadata:y,tableName:c});if(!o.success||o.error_message||!o.descriptions)throw Error(o.error_message||"Failed to get column descriptions. Queries might be less precise.");let d=o.descriptions;y.forEach(e=>{let t=d.find(t=>t.column_name===e.column_name);t&&(e.column_description=t.column_description)})}catch(e){console.log(e.stack),h.error(e.message)}A(l=>{let n=[...l],o={name:i,keyName:e,isTemp:!0,sqlOnly:m&&!0,metadata:y||null,data:Object.assign({},g||{}),columns:r,sqliteTableName:c,metadataFetchingError:!y&&"Error fetching metadata",predefinedQuestions:t,analysisTreeManager:ue({},"csv_"+Math.floor(1e3*Math.random()))};return n.push(o),n}),k(i)}catch(e){console.log(e.stack),h.error(e.message)}finally{O(!1)}},q=(0,n.useMemo)(()=>u.j.jsx(ze,{availableDbs:N,onSelectDb:e=>k(e),fileUploading:D,onParseCsv:w}),[N,D]),R=(0,n.useMemo)(()=>[{name:"Analysis",headerClassNames:(e,t)=>(0,u.t)("bg-gray-100","Analysis"===t.name&&e?"bg-gray-600 text-white hover:bg-gray-600":""),content:M&&I&&v&&j?u.j.jsx(qe,{predefinedQuestions:F,isTemp:T,keyName:I,treeManager:M,forceSqlOnly:_,metadata:E,searchBarDraggable:r,searchBarClasses:i}):q},{name:"View data structure",content:S?u.j.jsx(Le,{apiEndpoint:j,db:S,token:v,onGetMetadata:({metadata:e,error:t})=>{A(l=>{let r=[...l],n=l.findIndex(e=>e.name===C);return n<0||(r[n]=Object.assign({},r[n]),S.isTemp&&e.forEach(e=>{e.sqlite_table_name=S.sqliteTableName}),r[n].metadata=e,t&&(r[n].metadataFetchingError=t,r[n].data={},r[n].dataFetchingError=t||!1)),r})}},I):q},{name:"Preview data",content:S?u.j.jsx(Me,{apiEndpoint:j,db:S,token:v,onGetData:({data:e})=>{A(t=>{let l=[...t],r=t.findIndex(e=>e.name===C);return r<0||(l[r]=Object.assign({},l[r]),l[r].data=Object.assign({},e)),l})}},I):q}],[S,j,r,v,q]);return(0,n.useEffect)(()=>{S&&(S.isTemp?y.update({...y.val,isTemp:!0,sqlOnly:!0,keyName:S.keyName,metadata:S.metadata}):y.update({...y.val,isTemp:!1,sqlOnly:!1,keyName:S.keyName,metadata:S.metadata}))},[S]),u.j.jsx(Oe,{defaultSelectedDb:C,availableDbs:N.map(e=>e.name),onDbChange:e=>k(e),onParseCsv:w,rootClassNames:e=>"flex flex-col "+(e?"":"items-center justify-center"),fileUploading:D,children:u.j.jsx(g.T,{disableSingleSelect:!0,vertical:!0,rootClassNames:"grow h-[90%] w-full",contentClassNames:"mt-2 sm:mt-0 bg-white grow overflow-hidden shadow-custom rounded-2xl sm:rounded-tl-none",defaultTabClassNames:"pl-0 sm:mt-0 h-full",selectedTabHeaderClasses:e=>"Analysis"===e?"bg-transparent":"",tabs:R})})}function Ye({token:e,apiEndpoint:t="https://demo.defog.ai",user:l="admin",devMode:r=!1,showAnalysisUnderstanding:i=!0,showCode:o=!1,allowDashboardAdd:d=!0,disableMessages:m=!1,dbs:h=[],uploadedCsvIsSqlOnly:g=!0,uploadedCsvPredefinedQuestions:y=["Show me any 5 rows"],searchBarDraggable:p=!0,searchBarClasses:v="",csvFileKeyName:j=null,limitCsvUploadSize:N=!0,maxCsvUploadSize:A=10}){let C=(0,n.useMemo)(()=>h.map(e=>({isTemp:!1,sqlOnly:!1,metadata:null,data:{},metadataFetchingError:!1,analysisTreeManager:ue({},e.keyName+"_"+Math.floor(1e3*Math.random())),...e})),[h]);return u.j.jsx("div",{className:"w-full bg-gradient-to-br from-[#6E00A2]/10 to-[#FFA20D]/10 px-2 lg:px-0 py-8 h-screen flex items-center shadow-inner relative",children:u.j.jsx("div",{className:"w-full lg:w-10/12 min-h-96 h-[95%] overflow-y-hidden mx-auto",children:u.j.jsx(c.S,{token:e,user:l,apiEndpoint:t,devMode:r,showAnalysisUnderstanding:i,showCode:o,allowDashboardAdd:d,disableMessages:m,children:u.j.jsx(Pe,{uploadedCsvIsSqlOnly:g,dbs:C,uploadedCsvPredefinedQuestions:y,searchBarClasses:v,searchBarDraggable:p,csvFileKeyName:j||(h.length>0?h[0].keyName:null),limitCsvUploadSize:N,maxCsvUploadSize:A})})})})}var query_data=()=>{let[e,t]=(0,n.useState)(""),[l,c]=(0,n.useState)(""),[u,m]=(0,n.useState)(""),[h,g]=(0,n.useState)(!1);return(0,n.useEffect)(()=>{let e=localStorage.getItem("defogToken"),l=localStorage.getItem("defogUserType"),r=localStorage.getItem("defogUser");c(r),m(l),t(e)},[]),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.Z,{}),(0,r.jsx)(o.Z,{id:"query-data",userType:u,rootClassNames:"h-screen relative",children:(0,r.jsxs)("div",{className:"flex flex-col h-full",children:["admin"===u?(0,r.jsx)(d.ZD,{rootClassNames:"mx-auto p-2 absolute lg:fixed w-44 border bg-white rounded-md left-0 right-0 mx-auto top-2 lg:bottom-0 lg:top-auto lg:right-auto lg:shadow-md z-50",title:"Environment",onLabel:"Production",offLabel:"Development",defaultOn:!h,onToggle:e=>{g(!e)}}):null,e?(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(Ye,{token:e,user:l,devMode:h,apiEndpoint:"http://localhost:33364",uploadedCsvPredefinedQuestions:["Show me any 5 rows from the dataset"],showAnalysisUnderstanding:!1,dbs:"Defog".split(",").map(e=>({name:e,keyName:e,predefinedQuestions:"Manufacturing"===e?["What is the average rejection rate by lot?","Is there a difference in the plasticity of components that are rejected vs accepted?"]:"Sales"===e?["Who are our top 5 customers by revenue?","What was the month on month change in revenue?"]:"Slack"===e?["What is the count of number of queries by db type in the last 30 days, except for queries made by jp@defog.ai?","Which users have the most queries?"]:["Show me any 5 rows from the dataset"]}))})}):null]})})]})}}},function(e){e.O(0,[204,625,435,774,888,179],function(){return e(e.s=20328)}),_N_E=e.O()}]);