(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[137],{20328:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/query-data",function(){return s(40475)}])},26335:function(e,t,s){"use strict";var l=s(28598),r=s(1887),n=s.n(r);t.Z=()=>(0,l.jsxs)(n(),{children:[(0,l.jsx)("title",{children:"Defog.ai - AI Assistant for Data Analysis"}),(0,l.jsx)("meta",{name:"description",content:"Train your AI data assistant on your own device"}),(0,l.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1"}),(0,l.jsx)("link",{rel:"icon",href:"/favicon.ico"})]})},82067:function(e,t,s){"use strict";var l=s(28598),r=s(82684),n=s(97574),o=s(79869),i=s(34376);s(12691);var d=s(26978),c=s(47663),u=s(56572);t.Z=e=>{let{id:t,userType:s,children:m,rootClassNames:h="",contentClassNames:g=""}=e,{Content:f,Sider:p}=o.Layout,[v,j]=(0,r.useState)([]),[A,N]=(0,r.useContext)(n.S),C=(0,i.useRouter)(),redirect=e=>{C.push(e)},logout=()=>{localStorage.removeItem("defogUser"),localStorage.removeItem("defogToken"),localStorage.removeItem("defogUserType"),N({user:null,token:null,userType:null}),redirect("/static/log-in.html")},k=(0,c.usePathname)();(0,r.useEffect)(()=>{j(("admin"==s?[{key:"manage-database",title:"Manage Database",href:"/static/extract-metadata.html"},{key:"manage-users",title:"Manage Users",href:"/static/manage-users.html"},{key:"manage-tools",title:"Manage tools",href:"/static/manage-tools.html"},{key:"check-readiness",title:"Check Readiness",href:"/static/check-readiness.html"},{key:"align-model",title:"Align Model",href:"/static/align-model.html"},{key:"view-feedback",title:"View Feedback",href:"/static/view-feedback.html"},{key:"query-data",title:"Query Data",href:"/static/query-data.html"},{key:"logout",classNames:"self-end",title:"Logout",href:"#",onClick:logout}]:s?[{key:"query-data",title:"Query Data",href:"/static/query-data.html"},{key:"logout",classNames:"self-end",title:"Logout",href:"#",onClick:logout}]:[]).map(e=>(e.current=e.href==k,e)))},[s]);let[S,I]=(0,r.useState)("flex flex-col md:min-h-screen relative container mx-auto");return(0,r.useEffect)(()=>{"/query-data"===k&&I("flex flex-col md:min-h-screen relative")},[k]),(0,l.jsxs)("div",{className:(0,u.m6)(S,h),children:[v.length?(0,l.jsx)(d.l2,{rootClassNames:"border-b",items:v}):(0,l.jsx)(l.Fragment,{}),(0,l.jsx)("div",{className:(0,u.m6)("grow",g),children:m})]})}},40475:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return query_data}});var l=s(28598),r=s(82684),n=s(26335),o=s(82067),i=s(26978),d=s(35148),c=s(24014),u=s(21718),m=s(54161),h=s(28860);let g=r.forwardRef(function({title:e,titleId:t,...s},l){return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:l,"aria-labelledby":t},s),e?r.createElement("title",{id:t},e):null,r.createElement("path",{fillRule:"evenodd",d:"M17 4.25A2.25 2.25 0 0 0 14.75 2h-5.5A2.25 2.25 0 0 0 7 4.25v2a.75.75 0 0 0 1.5 0v-2a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 .75.75v11.5a.75.75 0 0 1-.75.75h-5.5a.75.75 0 0 1-.75-.75v-2a.75.75 0 0 0-1.5 0v2A2.25 2.25 0 0 0 9.25 18h5.5A2.25 2.25 0 0 0 17 15.75V4.25Z",clipRule:"evenodd"}),r.createElement("path",{fillRule:"evenodd",d:"M1 10a.75.75 0 0 1 .75-.75h9.546l-1.048-.943a.75.75 0 1 1 1.004-1.114l2.5 2.25a.75.75 0 0 1 0 1.114l-2.5 2.25a.75.75 0 1 1-1.004-1.114l1.048-.943H1.75A.75.75 0 0 1 1 10Z",clipRule:"evenodd"}))}),f=r.forwardRef(function({title:e,titleId:t,...s},l){return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:l,"aria-labelledby":t},s),e?r.createElement("title",{id:t},e):null,r.createElement("path",{d:"m13.28 7.78 3.22-3.22v2.69a.75.75 0 0 0 1.5 0v-4.5a.75.75 0 0 0-.75-.75h-4.5a.75.75 0 0 0 0 1.5h2.69l-3.22 3.22a.75.75 0 0 0 1.06 1.06ZM2 17.25v-4.5a.75.75 0 0 1 1.5 0v2.69l3.22-3.22a.75.75 0 0 1 1.06 1.06L4.56 16.5h2.69a.75.75 0 0 1 0 1.5h-4.5a.747.747 0 0 1-.75-.75ZM12.22 13.28l3.22 3.22h-2.69a.75.75 0 0 0 0 1.5h4.5a.747.747 0 0 0 .75-.75v-4.5a.75.75 0 0 0-1.5 0v2.69l-3.22-3.22a.75.75 0 1 0-1.06 1.06ZM3.5 4.56l3.22 3.22a.75.75 0 0 0 1.06-1.06L4.56 3.5h2.69a.75.75 0 0 0 0-1.5h-4.5a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 1.5 0V4.56Z"}))});function le({setActiveAnalysisId:e,setActiveRootAnalysisId:t,setAddToDashboardSelection:s=(...e)=>{},analysis:l=null,isActive:n=!1,extraClasses:o="",isDummy:i=!1,onClick:u=()=>{}}){let m=(0,r.useContext)(d.A);return c.j.jsxs("div",{className:(0,c.t)("flex flex-row items-center py-1 px-2 mb-2 hover:cursor-pointer hover:bg-gray-200 history-item",n?"font-bold bg-gray-200 ":"",i?"dummy-analysis":l.analysisId,o),onClick:()=>{t(null==l?void 0:l.rootAnalysisId),e(null==l?void 0:l.analysisId),u()},children:[c.j.jsx("div",{className:"grow",children:i?"New analysis":(0,c.s)(null==l?void 0:l.user_question)}),!i&&m.val.allowDashboardAdd&&c.j.jsx("div",{className:"rounded-sm hover:bg-blue-500 p-1 flex justify-center group ",onClick:()=>{e(null==l?void 0:l.analysisId),s(l)},children:c.j.jsx(d.F,{className:"h-4 w-4 text-gray-400 group-hover:text-white"})})]})}let _e=({analyses:e,activeAnalysisId:t})=>{let[s,l]=(0,r.useState)([]),n=(0,r.useRef)(null);return(0,r.useEffect)(()=>{if(!n.current)return;if(!t){s.length>0&&l([]);return}let r=n.current.closest(".history-list");if(!r)return;r.querySelectorAll(".linked-active").forEach(e=>{e.classList.remove("linked-active")}),r.querySelectorAll(".current-active").forEach(e=>{e.classList.remove("current-active")});let o=r.querySelector(`.${t}`);o&&o.classList.add("current-active");let i=e[t],d=[],c=[];for(;d.length<20&&!i.isRoot;){let t=e[i.directParentId];d.push(t);let s=r.getBoundingClientRect(),l=r.querySelector(`.${i.analysisId}`),n=r.querySelector(`.${t.analysisId}`),o=l.getBoundingClientRect(),u=n.getBoundingClientRect(),m={x:o.left-s.left-8,y:o.top-s.top+o.height/2},h={x:u.left-s.left-8,y:u.top-s.top+u.height/2},g=h.y-m.y,f=h.x-(m.x-10),p=`M ${m.x} ${m.y} l -10 0 l 0 ${g} l ${f} 0`;c.push(p),i=t}d.forEach(e=>{let t=r.querySelector(`.${e.analysisId}`);t&&t.classList.add("linked-active")}),l(c)},[e,t]),c.j.jsx("div",{className:"absolute l-0 t-0 pointer-events-none overflow-visible",ref:n,children:c.j.jsx("svg",{width:"100%",height:"100%",className:"overflow-visible",children:s.map((e,t)=>c.j.jsx("path",{d:e,className:"fill-transparent stroke-blue-300 text-blue-500",strokeWidth:"1"},t))})})};function Te({searchBarClasses:e="",searchBarDraggable:t=!0,loading:s=!1,handleSubmit:l,activeRootAnalysisId:n,activeAnalysisId:o,showToggle:i=!0,forceSqlOnly:d=!1,setSqlOnly:u,sqlOnly:h}){let p=(0,r.useRef)(null),v=(0,r.useRef)(null),j=(0,r.useRef)(!1);return(0,r.useEffect)(()=>{if(t)return a(),window.addEventListener("resize",a),()=>{window.removeEventListener("resize",a)};function a(){p.current&&(p.current.style.left="0",p.current.style.right="0",p.current.style.bottom=window.innerWidth>1600?"30%":"20px")}},[t]),(0,r.useEffect)(()=>{if(t)return document.addEventListener("mousemove",a),document.addEventListener("mouseup",y),()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",y)};function a(e){if(!j.current||!p.current)return;let t=window.innerHeight-e.clientY-p.current.clientHeight,s=e.clientX,l=window.innerHeight-20-p.current.clientHeight;t<20?p.current.style.bottom="20px":t>l?p.current.style.bottom=l+"px":p.current.style.bottom=t+"px";let r=window.innerWidth-p.current.clientWidth-20;p.current.style.right="auto",s<20?p.current.style.left="20px":s>r?p.current.style.left=r+"px":p.current.style.left=s+"px"}function y(){j.current=!1}},[t]),c.j.jsxs("div",{className:(0,c.t)("w-full lg:w-8/12 m-auto fixed z-20 bg-white rounded-lg shadow-custom border border-gray-400 hover:border-blue-500 focus:border-blue-500 flex flex-row",e),style:{left:"0",right:"0",bottom:t?window.innerWidth>1600?"30%":"20px":null},ref:p,children:[t&&c.j.jsx("div",{className:"flex items-center w-3 min-h-full ml-1 cursor-move group",onMouseDown:e=>{t&&(j.current=!0,e.preventDefault())},children:c.j.jsx(f,{className:"w-3 h-3 text-gray-400 group-hover:text-primary-text"})}),c.j.jsx("div",{className:"flex flex-col-reverse rounded-md grow lg:items-center lg:flex-row",children:c.j.jsxs("div",{className:"flex flex-row grow",children:[c.j.jsxs("div",{className:"flex flex-col lg:flex-row-reverse lg:items-center grow",children:[c.j.jsx(c.T,{rootClassNames:"grow border-none bg-transparent py-1.5 text-gray-900 px-2 placeholder:text-gray-400 sm:leading-6 text-sm break-all focus:ring-0 focus:outline-none",textAreaClassNames:"resize-none",ref:v,disabled:s,defaultRows:1,onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),e.stopPropagation(),l(v.current.value,n,!n,o))},placeholder:n?"Type your next question here":"Type your question here"}),i&&c.j.jsx(m.T,{disabled:d||s,titleClassNames:"font-bold text-gray-400",onToggle:e=>{d||u(!e)},defaultOn:!h,offLabel:"Advanced",onLabel:"Advanced",rootClassNames:"items-start lg:border-r py-2 lg:py-0 px-2 w-32"})]}),c.j.jsxs("button",{type:"button",className:"relative -ml-px inline-flex items-center gap-x-1.5 rounded-r-md px-3 p-0 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-blue-500 hover:bg-blue-500 hover:text-white",onClick:()=>{l(v.current.value,n,!n,o)},children:[c.j.jsx(g,{className:"-ml-0.5 h-5 w-5 text-gray-400","aria-hidden":"true"}),"Ask"]})]})})]})}function Re({analysisTreeManager:e,keyName:t,isTemp:s=!1,forceSqlOnly:l=!1,metadata:n=null,predefinedQuestions:o=[],autoScroll:i=!0,sideBarClasses:h="",searchBarClasses:g="",searchBarDraggable:f=!0,defaultSidebarOpen:p=!1,showToggle:v=!0}){var j;let A=(0,r.useContext)(c.M),N=(0,r.useRef)({}),[C,k]=(0,r.useState)(!1),[S,I]=(0,r.useState)(!0),_=(0,r.useRef)(null),[T,M]=(0,r.useState)(!1),[D,F]=(0,r.useState)([]),{dashboards:O}=(0,r.useContext)(d.A).val,[q,R]=(0,r.useState)(p),L=(0,u.u)(),P=(0,r.useSyncExternalStore)(e.subscribeToDataChanges,e.getTree),B=(0,r.useSyncExternalStore)(e.subscribeToDataChanges,e.getAll),z=(0,r.useSyncExternalStore)(e.subscribeToActiveAnalysisIdChanges,e.getActiveAnalysisId),U=(0,r.useSyncExternalStore)(e.subscribeToActiveAnalysisIdChanges,e.getActiveRootAnalysisId);(0,r.useEffect)(()=>{k(!1),F([]),M(!1),N.current={}},[e]);let Q=(0,r.useCallback)(async function(r,n=null,o=!1,i=null){try{if(!e)throw Error("Analysis tree manager not found");k(!0);let{newId:d,newAnalysis:c}=await e.submit({question:r,rootAnalysisId:n,keyName:t,isRoot:o,directParentId:i,sqlOnly:l||S,isTemp:s});n||e.setActiveRootAnalysisId(c.analysisId),e.setActiveAnalysisId(c.analysisId),e.setActiveRootAnalysisId(c.rootAnalysisId)}catch(e){A.error("Failed to create analysis"),console.log(e.stack)}finally{k(!1)}},[e,l,S,s,t,n]);function x(e){var t,s;null!=(s=null==(t=N.current)?void 0:t[e])&&s.ctr&&N.current[e].ctr.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}return window.ref=_,c.j.jsxs(d.E,{children:[c.j.jsxs("div",{className:"relative h-full",children:[z&&U&&c.j.jsx("div",{className:"lg:hidden absolute bottom-0 left-0 w-full h-[10%] pointer-events-none bg-gradient-to-b from-transparent to-gray-300 z-10"}),c.j.jsxs("div",{className:"flex flex-row w-full h-full max-w-full text-gray-600 bg-white analysis-tree-viewer",children:[c.j.jsx("div",{className:"absolute left-0 top-0 z-[20] lg:sticky",children:c.j.jsx(m.S,{location:"left",open:q,onChange:e=>{R(e)},title:c.j.jsx("span",{className:"font-bold",children:"History"}),rootClassNames:(0,c.t)("transition-all z-20 h-[calc(100%-1rem)] rounded-md rounded-l-none lg:rounded-none lg:rounded-tr-md lg:rounded-br-md bg-gray-100 border-r sticky top-0 lg:relative",h),iconClassNames:`${q?"":"text-white bg-secondary-highlight-2"}`,openClassNames:"border-gray-300 shadow-md",closedClassNames:"border-transparent bg-transparent shadow-none",contentClassNames:"w-72 px-2 pt-5 pb-14 rounded-tl-lg relative sm:block pl-4 min-h-96 h-full overflow-y-auto",children:c.j.jsxs("div",{className:"relative flex flex-col text-sm history-list",children:[c.j.jsx(_e,{analyses:B,activeAnalysisId:null!=B&&B[z]?z:null}),Object.keys(P).map((t,s)=>{var l;let r=P[t].root,n=(null==(l=null==P?void 0:P[t])?void 0:l.analysisList)||[];return c.j.jsx("div",{className:"",children:n.map((t,s)=>c.j.jsx(le,{analysis:t,isActive:z===t.analysisId,setActiveRootAnalysisId:e.setActiveRootAnalysisId,setActiveAnalysisId:e.setActiveAnalysisId,setAddToDashboardSelection:M,onClick:()=>{i&&x(t.analysisId),L[0]<u.b.lg&&R(!1)},extraClasses:t.isRoot?"":"ml-2 border-l-2"},t.analysisId))},r.analysisId)}),U?c.j.jsxs("div",{className:"sticky w-full mt-5 bottom-5",children:[c.j.jsxs("div",{"data-enabled":!C,className:(0,c.t)("flex items-center cursor-pointer z-20 relative","data-[enabled=true]:bg-blue-200 data-[enabled=true]:hover:bg-blue-500 data-[enabled=true]:hover:text-white p-2 data-[enabled=true]:text-blue-400 data-[enabled=true]:shadow-custom ","data-[enabled=false]:bg-gray-100 data-[enabled=false]:hover:bg-gray-100 data-[enabled=false]:hover:text-gray-400 data-[enabled=false]:text-gray-400 data-[enabled=false]:cursor-not-allowed"),onClick:()=>{C||(e.setActiveRootAnalysisId(null),e.setActiveAnalysisId(null),L[0]<u.b.lg&&R(!1))},children:["New ",c.j.jsx(d.F,{className:"inline w-4 h-4 ml-2"})]}),c.j.jsx("div",{className:"absolute z-0 w-full h-10 bg-gray-100"})]}):c.j.jsx(le,{isDummy:!0,setActiveRootAnalysisId:e.setActiveRootAnalysisId,setActiveAnalysisId:e.setActiveAnalysisId,isActive:!U})]})})}),c.j.jsx("div",{className:(0,c.t)("absolute left-0 top-0 h-full w-full overlay lg:hidden bg-gray-800 z-[11] transition-all",q?"opacity-50 block":"opacity-0 pointer-events-none"),onClick:()=>{R(!1)}}),c.j.jsxs("div",{className:"relative grid h-full min-w-0 grid-cols-1 p-2 pt-10 overflow-auto rounded-tr-lg sm:pt-0 auto-cols-max lg:grid-cols-1 grow lg:p-4",children:[U&&(null==(j=null==P?void 0:P[U])?void 0:j.analysisList)&&P[U].analysisList.map(t=>{var s;let l=t.rootAnalysisId,r=(null==(s=null==P?void 0:P[l])?void 0:s.analysisList)||[];return c.j.jsx(d.a,{metadata:n,rootClassNames:"w-full mb-4 [&_.analysis-content]:min-h-96 shadow-md analysis-"+t.analysisId,analysisId:t.analysisId,createAnalysisRequestBody:t.createAnalysisRequestBody,initiateAutoSubmit:!0,hasExternalSearchBar:!0,setGlobalLoading:k,sqlOnly:t.sqlOnly,isTemp:t.isTemp,keyName:t.keyName,userQuestions:r.map(e=>({...e})),onManagerCreated:(s,l,r)=>{N.current[l]={ctr:r,analysisManager:s,id:l},i&&x(l),e.updateAnalysis({analysisId:t.analysisId,isRoot:t.isRoot,updateObj:{analysisManager:s}})},onManagerDestroyed:(s,l)=>{e.removeAnalysis({analysisId:t.analysisId,isRoot:t.isRoot,rootAnalysisId:t.rootAnalysisId}),e.setActiveAnalysisId(null),U===l&&e.setActiveRootAnalysisId(null),k(!1)},initialConfig:{analysisManager:t.analysisManager||null}},t.analysisId)}),!z&&c.j.jsx("div",{className:" grow flex flex-col place-content-center m-auto max-w-full relative z-[1]",children:c.j.jsxs("div",{className:"text-center text-gray-400 rounded-md",children:[c.j.jsx("p",{className:"block mb-4 text-sm font-bold cursor-default",children:"Quickstart"}),c.j.jsx("ul",{className:"font-light text-gray-500",children:o.map((e,t)=>c.j.jsx("li",{className:"",children:c.j.jsx("button",{className:(0,c.t)("cursor-pointer text-sm p-2 m-1 border border-gray-200 rounded-md shadow-sm",C?"bg-gray-100 text-gray-300 cursor-not-allowed":"hover:bg-gray-50 hover:border"),onClick:t=>{C||Q((0,c.s)(e),U,!U,z)},children:(0,c.s)(e)})},t))})]})}),c.j.jsx(Te,{searchBarClasses:g,searchBarDraggable:f,loading:C,handleSubmit:Q,activeRootAnalysisId:U,activeAnalysisId:z,showToggle:v,forceSqlOnly:l,setSqlOnly:I,sqlOnly:S})]})]})]}),c.j.jsx(d.M,{title:"Select the dashboards to add this analysis to",open:T,onOk:()=>{},onCancel:()=>{M(!1)},children:c.j.jsx("div",{className:"flex flex-col mt-8 overflow-auto bg-gray-100 rounded-md dashboard-selection max-h-80",children:O.map(e=>c.j.jsxs("div",{className:"flex flex-row p-2 hover:bg-gray-200 cursor-pointer text-gray-400 items-start "+(D.includes(e.doc_id)&&"text-gray-600 font-bold"),onClick:()=>{D.includes(e.doc_id)?F(D.filter(t=>t!==e.doc_id)):F([...D,e.doc_id])},children:[c.j.jsx("div",{className:"mr-3 checkbox",children:c.j.jsx("input",{className:"w-3 h-3 border border-gray-300 rounded-md appearance-none checked:bg-blue-600 checked:border-transparent",type:"checkbox",checked:D.includes(e.doc_id),readOnly:!0})}),c.j.jsx("div",{className:"grow",children:e.doc_title})]},e.doc_id))})})]})}function Le({rootClassNames:e=e=>"",availableDbs:t=[],defaultSelectedDb:s=null,allowUploadFile:l=!0,onDbChange:n=(...e)=>{},children:o=null,fileUploading:i=!1,onParseCsv:d=(...e)=>{}}){let[m,g]=(0,r.useState)(s),[f,p]=(0,r.useState)(!1),v=(0,r.useContext)(c.M);return(0,r.useEffect)(()=>{g(s)},[s]),c.j.jsxs("div",{className:(0,c.t)("w-full h-full p-2","function"==typeof e?e(m):""),children:[c.j.jsxs("div",{className:"w-full relative mb-4 text-gray-500 text-xs flex flex-row",children:[c.j.jsx("div",{className:"h-full mr-2 font-bold z-10 whitespace-nowrap py-2",children:"Dataset:"}),c.j.jsx("div",{className:"overflow-auto flex flex-row gap-2 px-2 items-center rounded-md",children:t.map((e,t)=>c.j.jsx("span",{onClick:()=>{i||(g(e),n(e))},className:(0,c.t)("p-2 bg-gray-200 border border-gray-300 rounded-full cursor-pointer whitespace-nowrap",m===e?"bg-gray-600 border-transparent text-white":"hover:bg-gray-300",i?"cursor-not-allowed bg-gray-200 text-gray-400 hover:bg-gray-200":""),children:e},e+"-"+t))}),c.j.jsx("div",{className:"self-end ml-auto pl-3",children:l&&c.j.jsx(h.D,{rootClassNames:"flex items-center cursor-pointer group ml-auto self-end",disabled:i,onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),p(!0),console.log(e.target)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),p(!1)},onFileSelect:e=>{try{let t=e.target.files[0];if(!t)return;if("text/csv"!==t.type)throw Error("Only CSV files are accepted");(0,c.p)(t,d)}catch(e){v.error(e.message||"Only CSV files are accepted."),p(!1)}},onDrop:e=>{var t,s;console.log("here"),e.preventDefault();try{let l=null==(s=null==(t=null==e?void 0:e.dataTransfer)?void 0:t.items)?void 0:s[0];if(console.log(l),!l)return;if(!l.kind||"file"!==l.kind||"text/csv"!==l.type)throw Error("Only CSV files are accepted");l=l.getAsFile(),(0,c.p)(l,d)}catch(e){v.error(e.message||"Failed to parse the file"),console.log(e.stack),p(!1)}},children:c.j.jsx("span",{className:(0,c.t)("rounded-full cursor-pointe p-2 flex items-center whitespace-nowrap",i?"bg-gray-200 text-gray-400":"bg-secondary-highlight-1/40 text-white group-hover:bg-secondary-highlight-1 group-hover:text-white"),children:i?c.j.jsxs(c.j.Fragment,{children:["Uploading",c.j.jsx(c.S,{classNames:"h-4 w-4 inline m-0 ml-2 text-gray-500"})]}):c.j.jsxs(c.j.Fragment,{children:[c.j.jsx("span",{className:"hidden sm:inline",children:f?"Drop here!":"Upload / Drop a CSV"}),c.j.jsx("span",{className:"inline sm:hidden",children:"Upload a CSV"}),c.j.jsx(u.F,{className:"h-4 w-4 inline ml-1"})]})})})})]}),o]})}function ue(e={},t=(0,c.v)()){let s=e,l=Object.values(s).reduce((e,t)=>({...e,[t.root.analysisId]:t.root,...t.analysisList.reduce((e,t)=>({...e,[t.analysisId]:t}),{})}),{}),r=[],n=[],o=null,i=null;function w(e,t){s=e,l=t,r.forEach(e=>e())}function a(){n.forEach(e=>e())}return{subscribeToDataChanges:function(e){return r=[...r,e],function(){r=r.filter(t=>t!==e)}},getTree:function(){return s},getAll:function(){return l},subscribeToActiveAnalysisIdChanges:function(e){return n.push(e),function(){n=n.filter(t=>t!==e)}},setActiveAnalysisId:function(e){o=e,a()},setActiveRootAnalysisId:function(e){i=e,a()},getActiveAnalysisId:function(){return o},getActiveRootAnalysisId:function(){return i},submit:async function({question:e,keyName:t,rootAnalysisId:r=null,isRoot:n=!1,directParentId:o=null,sqlOnly:i=!1,isTemp:d=!1}){let u="analysis-"+(0,c.v)(),m={analysisId:u,isRoot:n,rootAnalysisId:n?u:r,user_question:e,existingAnalysisData:null,isTemp:d,keyName:t,sqlOnly:i};m.directParentId=o,m.createAnalysisRequestBody={other_data:{user_question:e,is_root_analysis:n,root_analysis_id:r,direct_parent_id:o},sql_only:i};let h={...s};if(r){let e=s[r].root;h[e.analysisId].analysisList.push(m)}else h[m.analysisId]={root:m,analysisList:[m]};let g={...l,[m.analysisId]:m};return w(h,g),{newId:u,newAnalysis:m}},removeAnalysis:function({analysisId:e,isRoot:t,rootAnalysisId:r}){let n={...s};if(t)delete n[e];else if(r){let t=n[r];t&&(t.analysisList=t.analysisList.filter(t=>t.analysisId!==e))}let o={...l};delete o[e],w(n,o)},updateAnalysis:function({analysisId:e,isRoot:t,updateObj:r,emit:n=!0}){let o={...s};if(!l[e]){console.warn("Analysis not found",e);return}t&&(o[e].root={...o[e].root,...r});let i=l[e].rootAnalysisId;o[i].analysisList=o[i].analysisList.map(t=>t.analysisId===e?{...t,...r}:t);let d={...l};d[e]={...d[e],...r},w(o,d)},getMgrId:()=>t,reset:function(){w({},{})}}}function Oe({apiEndpoint:e=null,db:t=null,token:s=null,onGetMetadata:l=(...e)=>{}}){let n=(0,r.useContext)(c.M),{keyName:o,metadata:i,isTemp:u}=t||{};(0,r.useEffect)(()=>{if(!t)return;let r=!!t.metadata;async function y(){let t;if(!s){n.error("Failed to get metadata");return}try{if((t=await (await fetch(`${e}/integration/get_metadata`,{signal:AbortSignal.timeout(1e4),method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({token:s,key_name:o,temp:u})})).json()).error)throw Error(t.error)}catch(e){console.log(e),n.error("Error getting metadata: "+t.error),t={error:t.error||"Error fetching metadata."}}finally{l(t)}}r||t.metadataFetchingError||y()},[t]);let m=(0,r.useMemo)(()=>Array.isArray(i)&&!t.metadataFetchingError?Array.from(new Set(i.map(e=>e.table_name))):[],[i,t]),g=Array.isArray(i)&&!t.metadataFetchingError?[{dataIndex:"table_name",title:"table_name",key:"table_name"},{dataIndex:"column_name",title:"column_name",key:"column_name"},{dataIndex:"column_description",title:"column_description",key:"column_description"},{dataIndex:"data_type",title:"data_type",key:"data_type"}]:[],[f,p]=(0,r.useState)(m);(0,r.useEffect)(()=>{p(m)},[o+m.join(",")]);let v=Array.isArray(i)&&!t.metadataFetchingError?i.filter(e=>0===f.length||f.includes(e.table_name)):[];return c.j.jsx(d.E,{children:c.j.jsx("div",{className:(0,c.t)("p-2 w-full h-full flex ",Array.isArray(i)&&!t.metadataFetchingError?"flex-col items-start justify-start":"items-center justify-center"),children:Array.isArray(i)&&!t.metadataFetchingError?c.j.jsx(c.j.Fragment,{children:c.j.jsxs("div",{className:"flex flex-col justify-center w-full",children:[c.j.jsx("div",{className:"py-2 border-b bg-white sticky top-2 mb-3 z-[20]",children:c.j.jsx(h.M,{rootClassNames:"max-w-full",placeholder:"Filter tables",value:[],options:m.map(e=>({label:e,value:e})),onChange:e=>{p(e)},allowCreateNewOption:!1})}),c.j.jsx(c.a,{pagination:{defaultPageSize:5},paginationPosition:"top",rootClassNames:"rounded-md max-w-full",columns:g,rows:v,columnHeaderClassNames:"py-2"})]})}):c.j.jsx("div",{className:"text-center",children:t.metadataFetchingError?t.metadataFetchingError:c.j.jsxs(c.j.Fragment,{children:[c.j.jsx("div",{children:"Fetching"})," ",c.j.jsx(c.S,{classNames:"w-4 h-4 text-gray-500"})]})})})})}function Me({keyName:e,treeManager:t,predefinedQuestions:s,searchBarDraggable:l=!0,isTemp:r=!1,forceSqlOnly:n=!1,metadata:o=null,sideBarClasses:i="h-full",searchBarClasses:u="",defaultSidebarOpen:m=null}){return c.j.jsx(d.E,{children:c.j.jsx(Re,{keyName:e,metadata:o,isTemp:r,forceSqlOnly:n,analysisTreeManager:t,autoScroll:!0,sideBarClasses:i,searchBarClasses:(0,c.t)(l?"":"sticky bottom-1","[&_textarea]:pl-2",u),searchBarDraggable:l,showToggle:!n,defaultSidebarOpen:m||!(window.innerWidth<768),predefinedQuestions:s})})}function qe({apiEndpoint:e=null,db:t=null,token:s=null,onGetData:l=(...e)=>{}}){var n,o,i,u;let m=(0,r.useContext)(c.M),{keyName:h,isTemp:g}=t||{};(0,r.useEffect)(()=>{t&&t.metadata&&!t.metadataFetchingError&&(!t.dataFetchingError&&!t.metadataFetchingError&&t.metadata&&t.data&&Object.keys(t.data).length>0||E());async function E(){let r;let n=Array.isArray(t.metadata)&&!t.metadataFetchingError?Array.from(new Set(t.metadata.map(e=>e.table_name))):[],o={};n.forEach(async(t,i)=>{let d;o[t]={data:[],columns:[],error:!1};try{if(!s)throw Error("Failed to get data");if((d=await (await fetch(`${e}/integration/preview_table`,{signal:AbortSignal.timeout(1e4),method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({token:s,key_name:h,temp:g,table_name:t})})).json()).error)throw Error(d.error);d.tableName=t}catch(e){console.log(e),r=e,m.error("Error getting data: "+d.error),d={error:d.error||"Failed to fetch data.",data:[],columns:[]}}finally{o[t]={...o[t],data:d.data.slice(),columns:d.columns.slice()},i===n.length-1&&l({data:o,error:r})}})}},[t]);let f=!t.dataFetchingError&&!t.metadataFetchingError&&t.metadata&&t.data&&Object.keys(t.data).length>0,p=t.dataFetchingError||t.metadataFetchingError,v=Array.isArray(t.metadata)&&!t.metadataFetchingError?Array.from(new Set(t.metadata.map(e=>e.table_name))):[],[j,A]=(0,r.useState)(0),N=((null==(o=null==(n=null==t?void 0:t.data)?void 0:n[null==v?void 0:v[j]])?void 0:o.columns)||[]).map(e=>({dataIndex:e,key:e,title:e})),C=((null==(u=null==(i=null==t?void 0:t.data)?void 0:i[null==v?void 0:v[j]])?void 0:u.data)||[]).map(e=>{let t={};return N.forEach((s,l)=>{t[s.dataIndex]=e[l]}),t});return c.j.jsx(d.E,{children:c.j.jsx("div",{className:(0,c.t)("p-2 w-full h-full flex ",f?"":"items-center justify-center"),children:f?c.j.jsx(c.j.Fragment,{children:c.j.jsxs("div",{className:"flex flex-col py-2 relative w-full",children:[c.j.jsx("div",{className:"flex flex-row items-center mb-4 sticky top-4 z-[20] bg-white p-2 border-b",children:c.j.jsx(c.b,{value:j,onChange:e=>A(e),options:v.map((e,t)=>({value:t,label:e})),allowClear:!1,label:"Select table",allowCreateNewOption:!1})}),c.j.jsx("div",{className:"max-w-full overflow-auto",children:c.j.jsx(c.a,{pagination:{defaultPageSize:5},paginationPosition:"top",rootClassNames:"rounded-md max-w-full",columns:N,rows:C,columnHeaderClassNames:"py-2"})})]})}):p?c.j.jsx("div",{className:"text-center",children:t.dataFetchingError||t.metadataFetchingError}):c.j.jsx(c.j.Fragment,{children:c.j.jsxs("div",{className:"text-center",children:[c.j.jsx("div",{children:"Fetching"})," ",c.j.jsx(c.S,{classNames:"w-4 h-4 text-gray-500"})]})})})})}function ze({availableDbs:e=[],onSelectDb:t=(...e)=>{},onParseCsv:s=(...e)=>{},fileUploading:l=!1}){let n=(0,r.useContext)(c.M);return c.j.jsxs("div",{className:"w-full h-full flex flex-col gap-4 items-center justify-center",children:[c.j.jsx(c.b,{rootClassNames:"w-96 max-w-[90%] border p-4 rounded-md",label:"Please select a database",options:e.map(e=>(e.value=e.name,e.label=e.name,e)),disabled:l,onChange:e=>{t(e)}}),c.j.jsx(h.a,{label:"Or drop a CSV",rootClassNames:"w-96 max-w-[90%] border p-4 rounded-md text-gray-400",disabled:l,onFileSelect:e=>{e.preventDefault(),e.stopPropagation();try{let t=e.target.files[0];if(!t||"text/csv"!==t.type)throw Error("Only CSV files are accepted");(0,c.p)(t,s)}catch{n.error("Failed to parse the file")}},onDrop:e=>{var t,l;e.preventDefault(),e.stopPropagation();try{let r=null==(l=null==(t=null==e?void 0:e.dataTransfer)?void 0:t.items)?void 0:l[0];if(!r||!r.kind||"file"!==r.kind||"text/csv"!==r.type)throw Error("Only CSV files are accepted");r=r.getAsFile(),(0,c.p)(r,s)}catch(e){n.error("Failed to parse the file"),console.log(e.stack)}},showIcon:!1,children:l?c.j.jsxs("div",{className:"text-sm",children:["Uploading",c.j.jsx(c.S,{classNames:"h-4 w-4 inline m-0 ml-2 text-gray-400"})]}):c.j.jsxs(c.j.Fragment,{children:[c.j.jsx("span",{className:"inline sm:hidden",children:"Upload a CSV"}),c.j.jsx(u.F,{className:"h-6 w-6 inline text-gray-400"})]})})]})}function Pe({csvFileKeyName:e=null,uploadedCsvPredefinedQuestions:t=["Show me any 5 rows"],dbs:s,searchBarDraggable:l=!0,searchBarClasses:n="",limitCsvUploadSize:o=!0,maxCsvUploadSize:i=10,uploadedCsvIsSqlOnly:m=!0}){let h=(0,r.useContext)(c.M),g=(0,r.useContext)(d.A),{sqliteConn:f,token:p,apiEndpoint:v}=g.val,[j,A]=(0,r.useState)(s),[N,C]=(0,r.useState)(1===s.length?s[0].name:null),k=(0,r.useMemo)(()=>j.find(e=>e.name===N),[N,j]),S=(0,r.useMemo)(()=>{var e;return null==(e=j.find(e=>e.name===N))?void 0:e.keyName},[N,j]),I=(0,r.useMemo)(()=>{var e;return(null==(e=j.find(e=>e.name===N))?void 0:e.metadata)||null},[N,j]),_=(0,r.useMemo)(()=>{var e;return(null==(e=j.find(e=>e.name===N))?void 0:e.sqlOnly)||!1},[N,j]),T=(0,r.useMemo)(()=>{var e;return(null==(e=j.find(e=>e.name===N))?void 0:e.isTemp)||!1},[N,j]),M=(0,r.useMemo)(()=>{var e;return null==(e=j.find(e=>e.name===N))?void 0:e.analysisTreeManager},[N,j]),D=(0,r.useMemo)(()=>{var e;return(null==(e=j.find(e=>e.name===N))?void 0:e.predefinedQuestions)||[]},[N,j]),[F,O]=(0,r.useState)(!1),b=async({file:s,columns:l,rows:r})=>{try{if(!f)throw Error("SQLite connection not initialized. Please refresh the page and try again. If the error persists, please reach out to us.");if(O(!0),o&&s.size>1048576*i)throw Error("File size is too large. Max size allowed is 10MB.");let n=s.name.split(".")[0];j.find(e=>e.name===n)&&(n=n+"_"+Math.floor(1e3*Math.random()));let d=(0,c.c)("csv_"+n),u=null,g=null;if(f)try{let{columnMetadata:t,fiveRowsAsArraysOfValues:s}=(0,c.d)({conn:f,tableName:d,rows:r,columns:l});h.info("CSV parsed, now generating descriptions for columns!"),u={[d]:{data:s,columns:t.map(e=>e.dataIndex)}};let n=t.filter(e=>e.hasMultipleTypes);n.length>0&&h.warning(`Columns ${n.map(e=>`'${e.title}'`).join(",")} have values of multiple data types. This might cause issues.`),g=t.map(e=>({column_name:e.dataIndex,table_name:d,data_type:e.dataType}));let o=await (0,c.g)({apiEndpoint:v,keyName:e,metadata:g,tableName:d});if(!o.success||o.error_message||!o.descriptions)throw Error(o.error_message||"Failed to get column descriptions. Queries might be less precise.");let i=o.descriptions;g.forEach(e=>{let t=i.find(t=>t.column_name===e.column_name);t&&(e.column_description=t.column_description)})}catch(e){console.log(e.stack),h.error(e.message)}A(s=>{let r=[...s],o={name:n,keyName:e,isTemp:!0,sqlOnly:m&&!0,metadata:g||null,data:Object.assign({},u||{}),columns:l,sqliteTableName:d,metadataFetchingError:!g&&"Error fetching metadata",predefinedQuestions:t,analysisTreeManager:ue({},"csv_"+Math.floor(1e3*Math.random()))};return r.push(o),r}),C(n)}catch(e){console.log(e.stack),h.error(e.message)}finally{O(!1)}},q=(0,r.useMemo)(()=>c.j.jsx(ze,{availableDbs:j,onSelectDb:e=>C(e),fileUploading:F,onParseCsv:b}),[j,F]),R=(0,r.useMemo)(()=>[{name:"Analysis",headerClassNames:(e,t)=>(0,c.t)("bg-gray-100","Analysis"===t.name&&e?"bg-gray-600 text-white hover:bg-gray-600":""),content:M&&S&&p?c.j.jsx(Me,{predefinedQuestions:D,isTemp:T,keyName:S,treeManager:M,forceSqlOnly:_,metadata:I,searchBarDraggable:l,searchBarClasses:n}):q},{name:"View data structure",content:k?c.j.jsx(Oe,{apiEndpoint:v,db:k,token:p,onGetMetadata:({metadata:e,error:t})=>{A(s=>{let l=[...s],r=s.findIndex(e=>e.name===N);return r<0||(l[r]=Object.assign({},l[r]),k.isTemp&&e.forEach(e=>{e.sqlite_table_name=k.sqliteTableName}),l[r].metadata=e,t&&(l[r].metadataFetchingError=t,l[r].data={},l[r].dataFetchingError=t||!1)),l})}},S):q},{name:"Preview data",content:k?c.j.jsx(qe,{apiEndpoint:v,db:k,token:p,onGetData:({data:e})=>{A(t=>{let s=[...t],l=t.findIndex(e=>e.name===N);return l<0||(s[l]=Object.assign({},s[l]),s[l].data=Object.assign({},e)),s})}},S):q}],[k,v,l,p,q]);return(0,r.useEffect)(()=>{k&&(k.isTemp?g.update({...g.val,isTemp:!0,sqlOnly:!0,keyName:k.keyName,metadata:k.metadata}):g.update({...g.val,isTemp:!1,sqlOnly:!1,keyName:k.keyName,metadata:k.metadata}))},[k]),c.j.jsx(Le,{defaultSelectedDb:N,availableDbs:j.map(e=>e.name),onDbChange:e=>C(e),onParseCsv:b,rootClassNames:e=>"flex flex-col "+(e?"":"items-center justify-center"),fileUploading:F,children:c.j.jsx(u.T,{disableSingleSelect:!0,vertical:!0,rootClassNames:"grow h-[90%] w-full",contentClassNames:"mt-2 sm:mt-0 bg-white grow overflow-hidden shadow-custom rounded-2xl sm:rounded-tl-none",defaultTabClassNames:"pl-0 sm:mt-0 h-full",selectedTabHeaderClasses:e=>"Analysis"===e?"bg-transparent":"",tabs:R})})}function Ze({token:e,apiEndpoint:t="https://demo.defog.ai",user:s="admin",devMode:l=!1,showAnalysisUnderstanding:n=!0,showCode:o=!1,allowDashboardAdd:i=!0,disableMessages:u=!1,dbs:m=[],uploadedCsvIsSqlOnly:h=!0,uploadedCsvPredefinedQuestions:g=["Show me any 5 rows"],searchBarDraggable:f=!0,searchBarClasses:p="",csvFileKeyName:v=null,limitCsvUploadSize:j=!0,maxCsvUploadSize:A=10}){let N=(0,r.useMemo)(()=>m.map(e=>({isTemp:!1,sqlOnly:!1,metadata:null,data:{},metadataFetchingError:!1,analysisTreeManager:ue({},e.keyName+"_"+Math.floor(1e3*Math.random())),...e})),[m]);return c.j.jsx("div",{className:"w-full bg-gradient-to-br from-[#6E00A2]/10 to-[#FFA20D]/10 px-2 lg:px-0 py-8 h-screen flex items-center shadow-inner relative",children:c.j.jsx("div",{className:"w-full lg:w-10/12 min-h-96 h-[95%] overflow-y-hidden mx-auto",children:c.j.jsx(d.S,{token:e,user:s,apiEndpoint:t,devMode:l,showAnalysisUnderstanding:n,showCode:o,allowDashboardAdd:i,disableMessages:u,children:c.j.jsx(Pe,{uploadedCsvIsSqlOnly:h,dbs:N,uploadedCsvPredefinedQuestions:g,searchBarClasses:p,searchBarDraggable:f,csvFileKeyName:v||(m.length>0?m[0].keyName:null),limitCsvUploadSize:j,maxCsvUploadSize:A})})})})}var p=s(48497);function TestDrive(e){let{token:t,dbs:s,devMode:r}=e;return(0,l.jsx)(Ze,{apiEndpoint:p.env.NEXT_PUBLIC_AGENTS_ENDPOINT||"",token:t,uploadedCsvPredefinedQuestions:["Show me any 5 rows from the dataset"],searchBarDraggable:!1,searchBarClasses:"sticky bottom-2",dbs:s,disableMessages:!1,devMode:r})}var v=s(48497),query_data=()=>{let[e,t]=(0,r.useState)(""),[s,d]=(0,r.useState)(""),[c,u]=(0,r.useState)(""),[m,h]=(0,r.useState)(!1),g=(v.env.NEXT_PUBLIC_API_KEY_NAMES||"Your dataset").split(",");return(0,r.useEffect)(()=>{let e=localStorage.getItem("defogToken"),s=localStorage.getItem("defogUserType"),l=localStorage.getItem("defogUser");d(l),u(s),t(e)},[]),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.Z,{}),(0,l.jsx)(o.Z,{id:"query-data",userType:c,rootClassNames:"h-screen relative",children:(0,l.jsxs)("div",{className:"flex flex-col h-full",children:["admin"===c?(0,l.jsx)(i.ZD,{rootClassNames:"mx-auto p-2 absolute lg:fixed w-44 border bg-white rounded-md left-0 right-0 mx-auto top-2 lg:bottom-0 lg:top-auto lg:right-auto lg:shadow-md z-50",title:"Environment",onLabel:"Production",offLabel:"Development",defaultOn:!m,onToggle:e=>{h(!e)}}):null,e?(0,l.jsx)(l.Fragment,{children:(0,l.jsx)(TestDrive,{token:e,devMode:m,dbs:g.map(e=>({name:e,keyName:e,predefinedQuestions:"Manufacturing"===e?["What is the average rejection rate by lot?","Is there a difference in the plasticity of components that are rejected vs accepted?"]:"Sales"===e?["Who are our top 5 customers by revenue?","What was the month on month change in revenue?"]:"Slack"===e?["What is the count of number of queries by db type in the last 30 days, except for queries made by jp@defog.ai?","Which users have the most queries?"]:["Show me any 5 rows from the dataset"]}))})}):null]})})]})}}},function(e){e.O(0,[152,222,435,774,888,179],function(){return e(e.s=20328)}),_N_E=e.O()}]);