## How does an agent call work?

1. User asks a question
2. We decide if the question can be answered by just SQLCoder, or whether it needs an agent to answer the call. This is done using the `get_classification` function, which then makes a call to `https://api.defog.ai/classify_question`

- if the classification is SQLCoder only, we just use SQLCoder to answer the question and return the answer
- if the classification is "Agents", we move on to Step 3

3. We use a class called the "Clarifier" to see if the question asked was clear enough, or if it needs further refinements
4. If we have these clarifications, we can convert the question + the clarification statement into a "clearer" question, using another LLM call
5. We then give the clarified question to a "Planner" agent

- The planner agent then comes up with the first step of a plan, and determines if additional steps are needed to answer the question
- It executes this first step, along with retries in case of errors
- It then gets the data returned from the first step, and stores it
- It keeps producing additional steps until no additional steps are needed

6. [optional] If making a REST call, it can return the final answer to the user at this point

# Rest APIs

When we are making calls to the agent, we will do the following

[optional]
We can optionally call the Clarifier and Summarizer APIs if needed. This can be done directly by making calls to the api.defog.ai server, so no REST implementations are implemented here. In practice, if an Oracle is making calls to an agent, it is unlikely to ask vague questions. So we should be able to avoid implementing this!

- Clarifier API (easy => make a request to the api.defog.ai server)
- Summarizer API (easy => make a request to the api.defog.ai server)

[non-optional]
Once we have a clear question, we can make a POST request to `/plan_execute`, like below. That's it!

```python
import requests
r = requests.post("http://localhost:80/plan_and_execute", json={"question": "create a boxplot of ratings by city"})
r.json()['steps']
```

To just access the final values for the answer without any of the intermediary steps or the debugging tools, just look at `r.json()['steps'][-1]['result']['outputs']`

```json
[
  {
    "data": "rating,city_name\n4.5,Los Angeles\n3.8,Los Angeles\n4.2,Los Angeles\n4.7,New York\n3.9,New York\n4.3,New York\n4.1,San Francisco\n4.6,San Francisco\n3.7,San Francisco\n4.4,Miami\n4.6,Miami\n",
    "chart_images": [
      {
        "type": "boxplot",
        "path": "boxplots/boxplot-ee3a18c7-63b1-4a0f-b00a-5fa31b10debd.png"
      }
    ]
  }
]
```

To access any images that are generated by the agent, you can go to `/get_assets?path=IMAGE_PATH_FROM_OUTPUTS`. So for the image above, you can get it at `/get_assets?path=boxplots/boxplot-ee3a18c7-63b1-4a0f-b00a-5fa31b10debd.png`
